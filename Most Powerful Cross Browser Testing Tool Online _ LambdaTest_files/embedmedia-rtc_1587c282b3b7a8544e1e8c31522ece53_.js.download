!function(){"use strict";function f(e){try{return JSON.parse(e)}catch(e){}return"object"==typeof e?e:{}}function v(e){try{return JSON.stringify(e)}catch(e){}return""}function d(e){return"function"==typeof e}function C(e,t){this.container=t,this.sdpConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!1},this.audio="audio",this.screen_share="screen_share",this.curr_connection={audio:!1,screen_share:!1,video:!1},this.init(e)}C.prototype.init=function(e){this.chid=e.chatid,this.mid=e.id,this.type=e.type,this.localDescription="",this.remoteDescription="",this.localStream="",this.remoteStream="",this.localIceCandidates=[],this.remoteIceCandidates=[],this.iceRestart=e.iceRestart,this.isUpStream=e.isUpStream,this.connectionStatus="",this.rtcConnection="",this.isReconnecting=!1,this.remoteCandidatePushed=!1,this.mediaRequest=e.mediaRequest,this.reconnectInterval=null,this.statsObj=null,this.reconnectEndTimer=null,this.audioStream=null,this.screenStream=null,this.remoteStream=[],this.remoteAudioStream=null,this.remoteScreenStream=null,this.screenRtpSenders=null,this.audioRtpSenders=null,this.videoRtpSenders=null,this.isOfferer=!1,this.remoteTracksId=null,this.isNegotiation=!1,this.negotiationType=null,this.streamType={audio:"audioStream",screen_share:"screenStream",video:"videoStream"},this.streamData={audio:"audioRtpSenders",screen_share:"screenRtpSenders",video:"videoRtpSenders"},this.intRTCConn()},C.prototype.intRTCConn=function(){try{this.rtcConnection=new RTCPeerConnection(this.getCredentail()),this.getStream(),this.isUpStream&&(!this.iceRestart&&this[this.streamType[this.type]]&&this.addStream(),this.createOffer(),this[this.curr_connection[this.type]]=!0),this.getRemoteStream(),this.rtcConnectionStatus()}catch(e){}},C.prototype.getStream=function(){this[this.streamType[this.type]]=this.container.MediaPermission.getStreamByType(this.type)},C.prototype.getCredentail=function(){var e=this.mid,t=this.container.dataHandler.get(e+"_credential");if(t.credential){var i=f(t.credential),n=i.servers.split(","),a=i.user_name,o=i.token,r=[];return n.forEach(function(e){r.push({urls:e,username:a,credential:o})}),{iceServers:r}}return null},C.prototype.createOffer=function(){var t=this,e=this.getSDPConstraints();this.iceRestart&&(e.iceRestart=!0),this.rtcConnection.createOffer(e).then(function(e){return t.offerSuccessCallBack(e)}).catch(function(e){return t.offerErrorCallBack(e)})},C.prototype.offerSuccessCallBack=function(e){this.isOfferer=!0,this.localDescription=e,this.rtcConnection.setLocalDescription(new RTCSessionDescription(e));var t={description:e};this.isNegotiation&&(t.tracksId=this.tracksId,t.negotiationType=this.negotiationType);var i=this.contructResponse(t),n=this.type+"Impl";this.container[n].sendOffer(i),this.createIceCandidates()},C.prototype.offerErrorCallBack=function(){},C.prototype.createAnswer=function(){var t=this;this.rtcConnection.createAnswer(this.sdpConstraints).then(function(e){return t.answerSuccessCallBack(e)}).catch(function(e){return t.answerErrorCallBack(e)})},C.prototype.answerSuccessCallBack=function(e){this.localDescription=e,this.rtcConnection.setLocalDescription(new RTCSessionDescription(e));var t={description:e};this.negotiationType&&(t.tracksId=this.tracksId,t.negotiationType=this.negotiationType),this.container[this.type+"Impl"].sendAnswer(this.contructResponse(t))},C.prototype.addStream=function(){var t=this;this[this.streamType[this.type]]&&this[this.streamType[this.type]].getTracks().forEach(function(e){t[t.streamData[t.type]]="function"==typeof t.rtcConnection.addTrack?t.rtcConnection.addTrack(e,t[t.streamType[t.type]]):t.rtcConnection.addStream(t[t.streamType[t.type]])})},C.prototype.createIceCandidates=function(){var n=this;this.localIceCandidates=[],this.rtcConnection.onicecandidate=function(e){n.localIceCandidates.push(e);var t,i={};e.candidate&&(i.label=e.candidate.sdpMLineIndex,i.type="candidate",i.id=e.candidate.sdpMid,i.candidate=e.candidate.candidate,t={candidates:n.container.detailsHandler.toJSON(i)},n.container[n.type+"Impl"].sendCandidate(n.contructResponse(t)))}},C.prototype.setRemoteDescription=function(e){var t=this;this.negotiationType&&this.negotiationType==this.audio&&!this.audioRtpSenders&&(this.audioRtpSenders=this.addTrack(this.audioStream)),this.isUpStream||this.isReconnecting||this.iceRestart||!this.audioStream||this.audioRtpSenders||this.addStream(),this.rtcConnection.setRemoteDescription(new RTCSessionDescription(f(e))).then(function(){t.isOfferer||(t.createAnswer(),t.createIceCandidates()),t.clearReconnectNWTimer()}),this.remoteDescription=e,this.remoteCandidatePushed||this.pushIceCandidate(),this.negotiationType&&this.updateRemoteStream()},C.prototype.setOfferRemoteDescription=function(e){this.isOfferer=!1,this.localDescription=null,this.curr_connection.audio=!(!this.remoteTracksId||!this.remoteTracksId[this.audio]),this.curr_connection.screen_share=!(!this.remoteTracksId||!this.remoteTracksId[this.screen_share]),this.tracksId=this.container.MediaPermission.getTracksId(),this.setRemoteDescription(e)},C.prototype.setAnswerRemoteDesription=function(e){this.isOfferer=!0,this.setRemoteDescription(e)},C.prototype.pushIceCandidate=function(){var i=this;this.remoteIceCandidates.forEach(function(e){var t=new RTCIceCandidate({sdpMid:e.id,sdpMLineIndex:e.label,candidate:e.candidate});i.rtcConnection.addIceCandidate(t)}),this.remoteCandidatePushed=!0},C.prototype.setIceCandidates=function(e){var t,i=f(e.candidates?e.candidates:e.msg.candidate);this.remoteDescription&&this.localDescription?(this.remoteIceCandidates&&0<this.remoteIceCandidates.length&&!this.remoteCandidatePushed&&this.pushIceCandidate(),t=new RTCIceCandidate({sdpMid:i.id,sdpMLineIndex:i.label,candidate:i.candidate}),this.rtcConnection.addIceCandidate(t)):(this.remoteIceCandidates&&0<this.remoteIceCandidates.length||(this.remoteIceCandidates=[]),this.remoteIceCandidates.push(i))},C.prototype.rtcConnectionStatus=function(){var i=this;this.rtcConnection.oniceconnectionstatechange=function(){var e,t=i.rtcConnection.iceConnectionState;"connected"==t?(i.remoteIceCandidates=[],i.localIceCandidates=[],i.remoteDescription=null,i.localDescription=null,e=i.type+"Impl",i.container[e].callConnected(i),i.container.commonImpl.clearNetworkTimer(i)):"failed"==t&&i.initReconnect()},this.rtcConnection.onconnectionstatechange=function(e){"failed"==i.rtcConnection.connectionState&&i.initReconnect(),"connected"==i.rtcConnection.iceConnectionState&&(i.remoteIceCandidates=[],i.localIceCandidates=[],i.remoteDescription=null,i.localDescription=null,i.updateRemoteStream())}},C.prototype.initReconnect=function(){this.isReconnecting=!0,this.iceRestart=!0,this.remoteIceCandidates=[],this.remoteDescription=null,this.remoteCandidatePushed=!1,this.container.commonImpl.checkNetwork(this.chid,this.mid)},C.prototype.getRemoteStream=function(){var t=this;this.rtcConnection.onaddstream=this.rtcConnection.ontrack=function(e){t.remoteStream.push(e),t.container[t.type+"Impl"].addRemoteStream(e,t),t.negotiationType&&t.updateRemoteStream()}},C.prototype.updateRemoteStream=function(){for(var e in this.remoteStream){var t,i=this.remoteStream[e],n=null,n="track"==i.type?i.streams.id:i.stream.id;for(t in this.remoteTracksId){n==this.remoteTracksId[t]&&(this.container[t+"Impl"].addRemoteStream(i,this),t==this.screen_share&&i.stream&&(i.stream.onremovetrack=this.handleScreenTrackremoved))}}},C.prototype.handleScreenTrackremoved=function(){},C.prototype.contructResponse=function(e){var t=this.mid,i=this.type,n=this.chid;return Object.assign({},{mid:t,type:i,chid:n},e)},C.prototype.closeConnection=function(){try{this.rtcConnection.close(),this[this.streamType[this.type]]&&this.closeTracksInStream(this[this.streamType[this.type]])}catch(e){}},C.prototype.closeTracksInStream=function(e){try{e.getTracks().forEach(function(e){return e.stop()})}catch(e){}},C.prototype.getSDPConstraints=function(){var e=this.type,t=this.mid,i=this.chid,n=this.container,a=n.dataHandler,o=n.constants,r=a.get(i+"_call_status",!0)||{},s={offerToReceiveAudio:!0,offerToReceiveVideo:!0};return e==o.audio?s.offerToReceiveVideo=!0:e==o.screen_share&&(s.offerToReceiveVideo=r[t].mediarequest,s.offerToReceiveAudio=!0),s},C.prototype.clearReconnectNWTimer=function(){this.reconnectInterval&&(clearInterval(this.reconnectInterval),this.reconnectInterval=null,this.iceRestart=!1)},C.prototype.addAudioTrackInConnection=function(){this.audioStream=this.container.MediaPermission.getStreamByType(this.audio),this.audioRtpSenders=this.addTrack(this.audioStream),this.isNegotiation=!0,this.negotiationType=this.audio,this.tracksId=this.container.MediaPermission.getTracksId(),this.curr_connection.audio=!0,this.curr_connection.screen_share=!0,this.createOffer()},C.prototype.addScreenTrackInConnection=function(){var e=this;this.container.MediaPermission.getScreenShareStream(function(){e.screenStream=e.container.MediaPermission.getStreamByType(e.screen_share),e.screenRtpSenders=e.addTrack(e.screenStream),e.isNegotiation=!0,e.negotiationType=e.screen_share,e.tracksId=e.container.MediaPermission.getTracksId(),e.curr_connection.audio=!0,e.curr_connection.screen_share=!0,e.createOffer()},function(){})},C.prototype.removeScreenTrackInConnection=function(){this.rtcConnection.removeTrack(this.screenRtpSenders),this.container.MediaPermission.closeStreamByType(this.screen_share),this.isNegotiation=!0,this.negotiationType=this.audio,this.tracksId=this.container.MediaPermission.getTracksId(),this.curr_connection.audio=!0,this.curr_connection.screen_share=!1,this.screenRtpSenders=null,this.createOffer()},C.prototype.addTrack=function(t){var i,n=this;return t&&t.getTracks().forEach(function(e){i="function"==typeof n.rtcConnection.addTrack?n.rtcConnection.addTrack(e,t):n.rtcConnection.addStream(t)}),i};function e(e){((this.container=e).audioImpl=this).init(),this.audio="audio",this.timeout={},this.iconClicked={}}e.prototype.setCredential=function(e){this.container.commonImpl.setCredential(e)},e.prototype.handleInvitation=function(e,t){var i=this;void 0===t&&(t=0);var n=this.container,a=n.constants,o=n.detailsHandler,r=n.commonImpl,s=n.uiHandler,c=e.chatid,d=e.id,l=(e.mode,e.type),u=e.mediaRequest,p=a.WAITING_TIME_SECS;if(o.canShowAudioCallInvitation(c))try{var h,m,g=function(){clearTimeout(i.timeout[d]),i.handleUIReject(l,c,d)},f={chid:c,media_id:d,rejectCbk:g,acceptCbk:function(){clearTimeout(i.timeout[d]),i.handleUIAccept(l,c,d,e.mediaInvitation)}};if(r.checkIncomingCallAllowed(e))return r.makeCallReject(l,d),!0;this.setCredential(e),e.mediaInvitation?(setTimeout(function(){s.handleAudioCallInvite(l,f)},500),r.setCallStatus(c,d,l,"incoming","ringing",u,"downstream"),m={type:"audiocall",duration:(h=r.getActiveTab())?"3":p,tone:h?"outgoingcall":"incomingcall",chatid:c,isEncrypted:!1},r.playMediaNotificationSound(m),r.showDesktopNotif({chatid:c}),this.timeout[d]=setTimeout(g,65e3)):(r.setCallStatus(c,d,l,"incoming","connecting",u,"downstream"),this.handleUIAccept(l,c,d,e.mediaInvitation)),r.updateIncomingRequestData(e);var v="siqMedia: media invitation  | chid :"+c+" | mediaid : "+d+" | curUserId : "+o.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,v),o.triggerIconCheck(c)}catch(e){}else t<3&&(0==t&&o.joinChat(c),setTimeout(function(){return i.handleInvitation(e,t++)},3e3))},e.prototype.callConnected=function(e){var t=this,i=e.chid,n=e.type,a=e.mid,o=(e.isReconnecting,this.container),r=o.commonImpl,s=o.dataHandler,c=o.uiHandler,d=o.detailsHandler,l=r.getCallStatusByChid(i)[a].isdirectcall,u=(u=localStorage.getItem("siq_directcall"))&&f(u);clearTimeout(s.get(a+"_connecting_timer"));var p={chid:i,callEndCbk:l?function(){return t.handleUIApiCallEnd(i,n,a)}:function(){r.makeCallEnd(n,a),t.handleCallEnd({chatid:i,type:n,id:a})},muteCbk:function(){return t.toggleMute()},media_id:a,isDirectCall:l};c.updateCallInvitationState("audio",p,"connected"),r.updateCallStatus(i,a,"connected"),r.getEligibleMediaAction(i,n),d.triggerIconCheck(i),r.sendMediaStats({id:a},"call connected ");var h="siqMedia: Audio call connected  | chid :"+i+" | mediaid : "+a+" | curUserId : "+d.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,h);var m=s.get(i+"_peer");m&&m[a]&&m.reconnectEndTimer&&clearTimeout(m.reconnectEndTimer),u&&l&&(u.status="connected",localStorage.setItem("siq_directcall",v(u))),r.updateMediaStatsDetail({connectedTime:Date.now(),isreconnected:!1,mediaid:a});var g=r.getConnectedStatsDetail(a);r.makeCallConnected(g)},e.prototype.handleCallAccept=function(e){var t=this,i=e.chatid,n=e.id,a=e.type,o=e.processType,r=this.container,s=r.dataHandler,c=r.constants,d=r.commonImpl,l=r.uiHandler,u=r.detailsHandler;if(!o||o!=c.negotiation){var p=c.WAITING_TIME,h=i+"_peer",m=s.get(h)||{},g=d.getCallStatusByChid(i);e.isUpStream=!0,e.iceRestart=!1,m[n]=new C(e,this.container),clearTimeout(s.get(n+"_waiting_timer")),s.remove(n+"_waiting_timer"),s.set(h,m),d.updateCallStatus(i,n,"connecting"),s.set(n+"_connecting_timer",setTimeout(function(){d.makeCallEnd(a,n),t.clearData({type:a,chatid:i,id:n}),l.updateCallInvitationState("audio",{chid:i,media_id:n},"ended")},p));var f={chid:i,media_id:n,isDirectCall:g[n].isdirectcall,muteCbk:function(){return t.toggleMute()},rejectCbk:function(){return"upstream"==g[n].host?d.makeCallCancel(a,n):d.makeCallReject(a,n)}};l.updateCallInvitationState("audio",f,"connecting"),d.stopNotificationSound();try{var v={acceptedTime:Date.now(),callerType:0,lsid:u.getLsid(i),reconnectCount:0,type:a,mediaid:n};d.setMediaStatsDetail(v)}catch(e){}var y="siqMedia: call accept request received  | chid :"+i+" | mediaid : "+n+" | curUserId : "+u.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,y)}},e.prototype.handleCallReject=function(e){var t=e.chatid,i=e.id,n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.dataHandler,s=n.detailsHandler,c=a.getCallStatusByChid(t),d={chid:t,media_id:i,isDirectCall:c[i].isdirectcall};this.clearData(e),o.updateCallInvitationState("audio",d,"rejected"),clearTimeout(r.get(i+"_waiting_timer")),clearTimeout(r.get(i+"_connecting_timer")),delete c[i],a.removeCredential(i),s.handleCallRejected({type:"audio",chid:t});var l="siqMedia: call reject request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+s.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,l)},e.prototype.handleCandidates=function(e){var t=this.container.dataHandler,i=t.get(e.chatid+"_peer")[e.id];i||((i={})[e.id]=new C(e,this.container),t.set(e.chatid+"_peer",i),i=i[e.id]),i.setIceCandidates(e)},e.prototype.handleCallAnswer=function(e){e.chatid;var t=e.id,i=e.session,n=e.tracksId,a=e.negotiationType,o=this.container.dataHandler.get(e.chatid+"_peer")[t];o.remoteTracksId=n?JSON.parse(n):null,o.negotiationType=a||null,o.setAnswerRemoteDesription(i)},e.prototype.handleCallEnd=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=t.detailsHandler,o=i.getCallStatusByChid(e.chatid),r={chid:e.chatid,media_id:e.id,isDirectCall:o[e.id].isdirectcall};this.clearData(e),n.updateCallInvitationState("audio",r,"ended"),a.handleCallEnded({type:"audio",chid:e.chatid})},e.prototype.handleCallOffer=function(e){var t=e.chatid,i=e.id,n=e.session,a=e.tracksId,o=e.negotiationType,r=this.container.dataHandler,s=t+"_peer",c=r.get(s)||{};e.isUpStream=!1,e.iceRestart=!1;var d=c[i];c[i]||(c[i]=new C(e,this.container),r.set(t+"_peer",c),d=c[i]),d.remoteTracksId=a?JSON.parse(a):null,d.negotiationType=o||null,d.setOfferRemoteDescription(n)},e.prototype.handleCallCancel=function(e){try{var t=e.chatid,i=e.id,n=e.type,a=this.container,o=a.commonImpl,r=a.uiHandler,s=a.dataHandler,c=a.detailsHandler,d={chid:t,media_id:i,isDirectCall:o.getCallStatusByChid(t)[i].isdirectcall};o.removeCredential(i),r.updateCallInvitationState("audio",d,"cancelled"),clearTimeout(this.timeout[i]),clearTimeout(s.get(i+"_waiting_timer")),clearTimeout(s.get(i+"_connecting_timer"));var l="siqMedia: call cancel request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+c.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,l),this.clearData(e),c.handleCallCancelled({type:n,chid:t})}catch(e){}},e.prototype.clearData=function(e){try{var t=this.container,i=t.detailsHandler,n=t.commonImpl,a=e.type,o=e.chatid||e.chid,r=e.id||e.mid,s="siqMedia: before clearing Audio call data  | chid :"+o+" | mediaid : "+r+" | curUserId : "+i.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,s),this.closePeerConn(e),n.removeCredential(r),n.checkAVIcon(o),n.clearCallDetails(o,r),n.getActiveCallData()&&n.getActiveCallData()==o&&!n.getCallStatusByChid(o)&&(n.removeActiveCallData(),n.removeActiveTab(),this.clearMediaPermision(a)),n.removeIncomingRequestData(o),n.stopNotificationSound(),n.checkAndPlayNotification(),i.triggerIconCheck(o),n.clearConnectedStatsDetail(r)}catch(e){}},e.prototype.handleCallInvite=function(){},e.prototype.closePeerConn=function(e){var t=this.container,i=t.dataHandler,n=t.detailsHandler,a=e.chatid||e.chid,o=e.id||e.mid,r=e.type;try{var s=i.get(a+"_peer");s[o].closeConnection(),delete s[o],this.clearMediaPermision(r),this.removeAudioPlayer()}catch(e){var c="siqMedia: error while clearing peer connection  | chid :"+a+" | mediaid : "+o+" | curUserId : "+n.getCurrentUserId()+" | error msg :"+e;this.callBackAction(this.implConstants.postDebugLog,c)}},e.prototype.clearMediaPermision=function(e){this.container.MediaPermission.closeStreamByType(e)},e.prototype.startAudioCall=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.detailsHandler,o=i.uiHandler,r=i.MediaPermission,s=n.getActiveCallData();if(!this.iconClicked[e.chatid]){if(this.iconClicked[e.chatid]=!0,s){var c,d=n.getCallStatusByChid(s);for(c in d)if("audio"==d[c].type)return void delete this.iconClicked[e.chatid]}try{var l=e.chatid,u=a.isembed;if("visitor"!=e.mode||(!!u||this.isAudioCallAllowed(e))){if(a.isAudioCallDisabled(l))return void delete this.iconClicked[e.chatid];var p=function(){clearTimeout(h)},h=setTimeout(function(){p=o.mediaPermissionUI()},3e3);r.getAudioStream(function(){p(),t.onMediaPermissionSuccess(e).call(t)},this.onUpStreamMediaPermissionFailure(function(){return p()},l))}else{var m="siqMedia: To start AUDIO call - permission checks failed | chid - "+l+" ";this.callBackAction(this.implConstants.postDebugLog,m),delete this.iconClicked[e.chatid]}}catch(e){}}},e.prototype.constructResponeObj=function(e){return Object.assign({},{type:"audio"},e)},e.prototype.onMediaPermissionSuccess=function(e){var t=this;try{var i=this.container,n=i.constants,a=i.commonImpl,o=i.ajaxHandler,r=n.WAITING_TIME_SECS;e.mode=e.mode?e.mode:"visitor";var s=this.constructResponeObj(e);a.setActiveTab(),s.mediainvitation=e.mediainvitation||!1,s.mediarequest=e.mediarequest||!1;var c=a.constructURL(null,null);a.setActiveCallData(e.chatid);var d={type:"audiocall",duration:r,tone:"outgoingcall",chatid:e.chatid,isEncrypted:!0};return a.playMediaNotificationSound(d),function(){o.post(c,s,t.onstarted.bind(t),t.startCallFailure.bind(t))}}catch(e){}},e.prototype.onUpStreamMediaPermissionFailure=function(n,a){var o=this,e=this.container,r=e.commonImpl,s=e.uiHandler;return function(e,t){n();var i=r.getFailureMessage(e);s.mediaPermissionUnlock(),s.showDialog({desc:i,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),delete o.iconClicked[a]}},e.prototype.onDownStreamMediaPermissionFailure=function(n){var a=this,e=this.container,o=e.commonImpl,r=e.uiHandler;return function(e,t){try{n.cbk(),r.mediaPermissionUnlock();var i=o.getFailureMessage(e);o.makeCallReject("audio",n.id),a.clearData({type:"audio",chatid:n.chatid,id:n.id}),o.removeActiveTab(),r.updateCallInvitationState("audio",{chid:n.chatid,media_id:n.id},"rejected"),r.showDialog({desc:i,buttons:{accept:{text:"common.ok",callback:function(){return null}}}})}catch(e){}}},e.prototype.isAudioCallAllowed=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=t.detailsHandler,o=t.MediaDetails,r=e.chatid;try{var s=a.getVisitorBrowser(r),c=a.getVisitorPage(r),d=!0,l="",u="";return i.getMediaDataByChidAndType({chatid:r,type:this.audio})?!1:(a.isChatMonitor(r)?(u="AUDIO - call Not Allowed because chat is in monitor | chid - "+r+" | visitorId - ",l=a.I18N("av.info.chatinvite"),d=!1):"Google Chrome"!==s&&"Mozilla Firefox"!==s&&"Apple Safari"!==s&&"Opera"!==s?(l=a.I18N("av.info.visitorbrowsernotsupported"),u="AUDIO call - Failed visitor browser not supported | chid - "+r+" | visitorId -  | browser-"+s,d=!1):o.checkBrowserSupported()?"https"!=c.substring(0,5)?(l=a.I18N("av.info.insecuredwebsite"),u="AUDIO call-Failed Visitor not in secure connection | chid - "+r+" |  visitorId - ",d=!1):a.isGroupConversation(r)?(l=a.I18N("av.info.chatinvite"),u="AUDIO call-Failed Visitor not in secure connection | chid - "+r+" |  visitorId - ",d=!1):a.isAttenderBot(r)?(u="AUDIO call-Failed bot attender | chid - "+r+" |  visitorId - ",d=!1):a.isFaceBookIntegration(r)&&(l=a.I18N("av.info.facebookpagenotsupported"),u="AUDIO call-Failed Visitor is in Facebook page | chid - "+r+" |  visitorId - ",d=!1):(u="AUDIO call-Failed agent browser not supported| chid - "+r,d=!1),d||(n.showDialog({desc:l,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),this.callBackAction(this.implConstants.postDebugLog,u)),d)}catch(e){var p="failed in isAudioCallAllowed method | chid - "+r;this.callBackAction(this.implConstants.postDebugLog,p)}},e.prototype.sendOffer=function(e){this.container.commonImpl.sendOffer(e)},e.prototype.sendAnswer=function(e){this.container.commonImpl.sendAnswer(e)},e.prototype.sendCandidate=function(e){this.container.commonImpl.sendCandidate(e)},e.prototype.postDebugLog=function(e){this.container.detailsHandler.sendDebugLogger(e,null,null,!0)},e.prototype.callBackAction=function(e,t){({postDebugLog:this.postDebugLog.bind(this)})[e](t)},e.prototype.init=function(){this.implConstants={postDebugLog:"postDebugLog"}},e.prototype.addRemoteStream=function(e,t){var i=this.container,n=i.detailsHandler,a=i.commonImpl;try{var o="siqMedia: adding remote stream  | chid :"+t.chid+" | mediaid : "+t.mid+" | lsuid : "+n.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,o);var r="",s=e.stream;t.type==this.audio&&(r=this.addAudioPlayer()),e.streams&&(s=e.streams[0]);try{r.srcObject=s}catch(e){r.src=window.URL.createObjectURL(s)}a.checkAndUpdateUIForApi()}catch(e){var c="siqMedia: adding remote stream  | chid :"+t.chid+" | mediaid : "+t.mid+" | lsuid : "+n.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,c)}},e.prototype.addAudioPlayer=function(){try{var e="siqMedia: creating audio player stream  | curUserId : "+this.container.detailsHandler.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,e);var t=document.querySelector("#remoteaudio");if(null!=t&&null!=t&&0!=t.length)return t[0];var i=document.createElement("audio");return i.id="remoteaudio",i.autoplay=!0,document.querySelector("body").appendChild(i),i}catch(e){}},e.prototype.removeAudioPlayer=function(){var e=document.querySelector("#remoteaudio");e.parentNode.removeChild(e)},e.prototype.startCallFailure=function(){this.iconClicked={},callBackAction()},e.prototype.startcall=function(e,t,i){var n={},a=this.container,o=a.ajaxHandler,r=a.commonImpl;n.type=e,n.chatid=t,n.mode=i||"visitor";var s=r.constructURL(null,null);r.setActiveCallData(t),o.post(s,n,this.onstarted,this.startCallFailure)},e.prototype.handleUIReject=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler,s=a.getCallStatusByChid(t);o.updateCallInvitationState("audio",{chid:t,media_id:i,isDirectCall:s[i].isdirectcall},"rejected"),a.makeCallReject(e,i),this.clearData({type:e,chatid:t,id:i}),r.handleCallRejected({type:e,chid:t});var c=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+r.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,c)},e.prototype.handleUIEnd=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler;try{var s={chid:t,media_id:i,isDirectCall:call_status[id].isdirectcall};a.makeCallEnd(e,i),o.updateCallInvitationState("audio",s,"rejected"),r.triggerIconCheck(t),this.clearData({type:e,chatid:t,id:i}),this.container.detailsHandler.handleCallEnded({type:e,chid:t})}catch(e){}},e.prototype.endOngoingCall=function(e,t,i){try{var n=this.container,a=n.dataHandler,o=n.uiHandler,r=n.commonImpl,s=a.get(e+"_peer");if(s)for(var c in s){var d=s[c];o.updateCallInvitationState(d.type,{chid:e,media_id:d.mid},"ended"),r.makeCallEnd(d.type,d.mid,i),this.clearData(d),delete s[c]}else{r.makeCallEnd("audio",t,i),this.clearData({type:"audio",chatid:e,id:t})}r.removeActiveCallData(e)}catch(e){}},e.prototype.__handleUIAccept=function(i,n,a){var o=this,e=this.container,r=e.commonImpl,s=e.detailsHandler,c=e.uiHandler,t=e.MediaPermission,d=e.dataHandler,l=e.constants,u=r.getActiveCallData(),p=r.getCallStatusByChid(u),h=r.getCallStatusByChid(n);if(s.focusChatWindow(n),u&&u!=n){for(var m in p)!function(e){var t=p[e],i=t.type+"Impl",n=t.callStatus;"connected"==n?o.container[i].endOngoingCall(u,e,function(){return t.isdirectcall&&s.endSession(u)}):"ringing"!=n&&"connecting"!=n||(("upstream"==p[e].host?o.container[i].handleUICancel.bind(o):o.container[i].handleUIReject.bind(o))(t.type,u,t.id),r.removeActiveCallData())}(m)}var g=function(){clearTimeout(f)},f=setTimeout(function(){g=c.mediaPermissionUI()},3e3);t.getAudioStream(function(){g(),r.updateCallStatus(n,a,"connecting"),r.setActiveCallData(n),r.makeCallAccept("audio",a);var e={chid:n,media_id:a,muteCbk:function(){return o.toggleMute()},rejectCbk:function(){return"upstream"==h[a].host?o.handleUICancel(i,n,a):o.handleUIReject(i,n,a)}};c.updateCallInvitationState("audio",e,"connecting");var t=l.WAITING_TIME;d.set(a+"_connecting_timer",setTimeout(function(){r.makeCallEnd(i,a),o.clearData({type:i,chatid:n,id:a}),c.updateCallInvitationState("audio",{chid:n,media_id:a},"ended")},t))},this.onDownStreamMediaPermissionFailure({chatid:n,id:a,cbk:g})),r.removeIncomingRequestData(n),r.setActiveTab(),r.stopNotificationSound()},e.prototype.handleUIAccept=function(e,t,i,n){var a=this,o=this.container,r=o.detailsHandler,s=o.uiHandler,c=o.commonImpl,d=c.getActiveCallData();d&&d!=t?s.handleCallClash(function(){return a.__handleUIAccept(e,t,i,n)},function(){return a.handleUIReject(e,t,i)}):this.__handleUIAccept(e,t,i,n);var l={acceptedTime:Date.now(),callerType:1,lsid:r.getLsid(t),reconnectCount:0,type:e,mediaid:i};c.setMediaStatsDetail(l)},e.prototype.handleUICancel=function(e,t,i){var n=this.container,a=n.detailsHandler,o=n.uiHandler,r=n.commonImpl,s=n.dataHandler;o.updateCallInvitationState(e,{chid:t,media_id:i},"cancelled"),r.makeCallCancel(e,i),this.clearData({type:e,chatid:t,id:i}),a.handleCallCancelled({type:e,chid:t}),clearTimeout(this.timeout[i]),clearTimeout(s.get(i+"_waiting_timer")),clearTimeout(s.get(i+"_connecting_timer")),s.remove(i+"_waiting_timer");var c=" cancel trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+a.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,c)},e.prototype.toggleMute=function(){this.container.MediaPermission.toggleMute()},e.prototype.startVisitorAudioCall=function(e){var t={chatid:e,mode:"visitor",mediarequest:!0,mediainvitation:!0,type:"audio"};this.startAudioCall(t)},e.prototype.handleCallMissed=function(e){var t=this.container,i=t.detailsHandler,n=t.uiHandler;try{var a=e.chatid,o=e.id;this.clearData(e);var r={chid:a,media_id:o};clearTimeout(this.timeout[o]),n.updateCallInvitationState("audio",r,"missed"),i.handleCallMissed({type:"audio",chid:a})}catch(e){var s=" call missed  | chid :"+chatid+" | mediaid : "+id+" | curUserId : "+i.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,s)}},e.prototype.acceptAudioCallForDsk=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=i.getMediaDataByChidAndType({chatid:e,type:this.audio}).id;this.__handleUIAccept(this.type,e,a,!0),n.clearAudioCallInvite(this.audio,a)},e.prototype.rejectAudioCallForDsk=function(e){var t=this.container,i=t.commonImpl,n=t.uiHandler,a=i.getMediaDataByChidAndType({chatid:e,type:this.audio}).id;this.handleUIReject(this.type,e,a),n.clearAudioCallInvite(this.audio,a)},e.prototype.hasIncommingCall=function(e){var t,i=this.container.commonImpl.getCallStatusByChid(e);for(t in i){var n=i[t];if("audio"==n.type&&"incoming"==n.callType&&"ringing"==n.callStatus)return!0}return!1};function t(e){e.videoImpl=this}t.prototype.handleInvitation=function(){},t.prototype.handleCallAccept=function(){},t.prototype.handleCallReject=function(){},t.prototype.handleCandidates=function(){},t.prototype.handleCallAnswer=function(){},t.prototype.handleCallEnd=function(){},t.prototype.handleCallOffer=function(){},t.prototype.handleCallCancel=function(){},t.prototype.handleCallCancel=function(){},t.prototype.handleCallInvite=function(){};function i(e){(e.screenShareImpl=this).container=e,this.timeout={},this.init()}i.prototype.setCredential=function(e){this.container.commonImpl.setCredential(e)},i.prototype.handleInvitation=function(e){function t(e){void 0===e&&(e=!0),clearTimeout(n.timeout[o]),e?n.handleUIAccept(r,a,o):n.handleUIReject(r,a,o)}function i(){return t(!1)}var n=this,a=e.chatid,o=e.id,r=e.type,s=this.container,c=s.commonImpl,d=s.uiHandler,l=s.MediaPermission,u={chid:a,media_id:o,rejectCbk:i,acceptCbk:t};if(c.checkIncomingCallAllowed(e))return c.makeCallReject(r,o),!0;this.setCredential(e),e.mediaInvitation?(d.handleAudioCallInvite("screen_share",u),c.setCallStatus(a,o,r,"incoming","ringing",e.mediaRequest,"downstream"),this.timeout[o]=setTimeout(i,65e3)):(c.setCallStatus(a,o,r,"incoming","connecting",e.mediaRequest,"downstream"),e.mediaRequest?l.getScreenShareStream(function(){c.makeCallAccept("screen_share",o),l.screenEndFromBrowserUI(function(){return n.handleUIEnd({type:r,id:o,chatid:a})})},this.onMediaPermissionFailure(a,o)):(c.setActiveCallData(a),c.makeCallAccept("screen_share",o)),c.setActiveTab())},i.prototype.handleCallAccept=function(e){var t,i,n,a=this,o=e.chatid,r=e.id,s=e.type,c=e.processType,d=this.container,l=d.dataHandler,u=d.commonImpl,p=d.constants,h=d.uiHandler;c&&c==p.negotiation||(t=o+"_peer",i=l.get(t)||{},e.isUpStream=!0,e.iceRestart=!1,i[r]=new C(e,this.container),l.set(t,i),clearTimeout(l.get(r+"_waiting_timer")),l.remove(r+"_waiting_timer"),n={chid:o,media_id:r,muteCbk:function(){},rejectCbk:function(){u.makeCallCancel(s,r),h.updateCallInvitationState(s,{chid:o,media_id:r},"cancelled"),a.clearData(e)}},u.updateCallStatus(o,r,"connecting"),h.updateCallInvitationState(p.screen_share,n,p.connecting))},i.prototype.handleCallReject=function(e){var t=e.chatid,i=e.id,n=e.type,a=this.container.detailsHandler;this.container.uiHandler.updateCallInvitationState("screen_share",{chid:t,media_id:i},"rejected"),this.clearData(e),a.handleCallRejected({type:n,chid:t})},i.prototype.handleCandidates=function(e){var t=this.container.dataHandler,i=t.get(e.chatid+"_peer")[e.id];i||((i={})[e.id]=new C(e,this.container),t.set(e.chatid+"_peer",i),i=i[e.id]),i.setIceCandidates(e)},i.prototype.handleCallAnswer=function(e){e.chatid;var t=e.id,i=e.session,n=e.tracksId,a=e.negotiationType,o=this.container.dataHandler.get(e.chatid+"_peer")[t];o.remoteTracksId=n?JSON.parse(n):null,o.negotiationType=a||null,o.setAnswerRemoteDesription(i)},i.prototype.handleCallEnd=function(e){var t=e.type,i=e.id,n=e.chatid,a=this.container,o=a.uiHandler,r=a.detailsHandler;o.updateCallInvitationState(t,{chid:n,media_id:i},"ended"),r.clearPlayer(),this.clearData(e),r.handleCallEnded({type:t,chid:n})},i.prototype.handleCallOffer=function(e){var t=e.chatid,i=e.id,n=e.session,a=e.tracksId,o=e.negotiationType,r=this.container.dataHandler,s=t+"_peer",c=r.get(s)||{};e.isUpStream=!1,e.iceRestart=!1;var d=c[i];c[i]||(c[i]=new C(e,this.container),r.set(t+"_peer",c),d=c[i]),d.remoteTracksId=a?JSON.parse(a):null,d.negotiationType=o||null,d.setOfferRemoteDescription(n)},i.prototype.handleCallCancel=function(e){var t=e.chatid,i=e.id,n=e.type,a=this.container,o=a.commonImpl,r=a.uiHandler,s=a.detailsHandler,c={chid:t,media_id:i};o.removeCredential(i),r.updateCallInvitationState("screen_share",c,"cancelled"),this.clearData(e),clearTimeout(this.timeout[i]);var d="siqMedia: call cancel request received  | chid :"+t+" | mediaid : "+i+" | curUserId : "+s.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,d),s.handleCallCancelled({type:n,chid:t})},i.prototype.handleUIReject=function(e,t,i){var n=this.container,a=n.uiHandler,o=n.commonImpl,r=n.detailsHandler;a.updateCallInvitationState(e,{chid:t,mid:i},"rejected"),o.makeCallReject(e,i),this.clearData({type:e,chid:t,mid:i});var s=" reject trigger from UI | chid :"+t+" | mediaid : "+i+" | curUserId : "+r.getCurrentUserId();this.callBackAction(this.implConstants.postDebugLog,s),r.handleCallRejected({type:e,chid:t})},i.prototype.__handleUIAccept=function(i,n,a){var o=this,e=this.container,r=e.commonImpl,s=e.uiHandler,c=e.MediaPermission,t=r.getActiveCallData(),d=r.getCallStatusByChid(t),l=r.getCallStatusByChid(n);if(t&&t!=n)for(var u in d){var p=d[u].callStatus,h=d[u].id;"connected"==p?this.endOngoingCall(t):"ringing"!=p&&"connecting"!=p||(("upstream"==d[u].host?r.makeCallCancel.bind(r):r.makeCallReject.bind(r))(i,h),r.removeActiveCallData())}r.getCallStatusByChid(n)[a].mediarequest?c.getScreenShareStream(function(){var e,t=r.getCallStatusByChid(n);t&&t[a]?(r.updateCallStatus(n,a,"connecting"),r.setActiveCallData(n),r.makeCallAccept(i,a),e={chid:n,media_id:a,muteCbk:function(){return o.toggleMute()},rejectCbk:function(){return"upstream"==l[a].host?r.makeCallCancel(i,a):r.makeCallReject(i,a)}},s.updateCallInvitationState(i,e,"connecting"),c.screenEndFromBrowserUI(function(){return o.handleUIEnd({type:i,id:a,chatid:n})})):c.closeStreamByType(i)},this.onMediaPermissionFailure(n,a)):r.makeCallAccept("screen_share",id),r.removeIncomingRequestData(n),r.setActiveTab()},i.prototype.handleUIAccept=function(e,t,i,n){var a=this,o=this.container,r=o.uiHandler,s=o.commonImpl.getActiveCallData();s&&s!=t?r.handleCallClash(function(){return a.__handleUIAccept(e,t,i,n)},function(){return a.handleUIReject(e,t,i)}):this.__handleUIAccept(e,t,i,n)},i.prototype.startScreenShare=function(e){try{var t,i=this.container,n=i.detailsHandler,a=i.MediaPermission,o=i.commonImpl,r=e.mediarequest,s=e.chatid,c=!0,d=r?"view_screen":"share_screen";if("visitor"==e.mode){if(n.checkIsSSOnGoing(s,d))return;c=this.isScreenShareAllowed(e,d)}c?r?this.initRequest(this.onMediaPermissionSuccess(e)):a.getScreenShareStream(this.onMediaPermissionSuccess(e),this.onMediaPermissionFailure(s,e.id,!0)):(t="To start Siq Screen Share  - permission checks failed | chid - "+s+" ",this.callBackAction(this.implConstants.postDebugLog,t)),o.setActiveTab()}catch(e){}},i.prototype.initRequest=function(e){e()},i.prototype.onMediaPermissionSuccess=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.ajaxHandler;e.mode=e.mode?e.mode:"visitor";var o=this.constructResponeObj(e),r=n.constructURL(null,null);return n.setActiveCallData(e.chatid),function(){a.post(r,o,t.onstarted.bind(t),t.startCallFailure.bind(t))}},i.prototype.onMediaPermissionFailure=function(o,r,s){var c=this;return void 0===s&&(s=!1),function(e,t){try{var i=c.container,n=i.commonImpl,a=i.uiHandler;s||(n.makeCallReject("screen_share",r),a.updateCallInvitationState("screen_share",{chid:o,media_id:r},"rejected"))}catch(e){}}},i.prototype.constructResponeObj=function(e){return Object.assign({},{type:"screen_share"},e)},i.prototype.sendOffer=function(e){this.container.commonImpl.sendOffer(e)},i.prototype.sendAnswer=function(e){this.container.commonImpl.sendAnswer(e)},i.prototype.sendCandidate=function(e){this.container.commonImpl.sendCandidate(e)},i.prototype.onstarted=function(e){var t=this,i=f(f(e.msg||e.data.msg).media),n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.dataHandler,s=n.MediaPermission,c=n.detailsHandler,d=i.chatid,l=i.id,u=i.type,p=i.mediaRequest,h={};h.chid=d,h.id=l,h.type=u,h.callType="outgoing",h.callStatus="ringing",h.mediarequest=p,h.host="upstream";r.set(l+"_waiting_timer",setTimeout(function(){a.makeCallMissed(u,l),t.clearData(i),o.updateCallInvitationState(u,{chid:d,media_id:l},"missed")},6e4));var m=r.get(d+"_call_status",!0)||{};m[l]=h,r.set(d+"_call_status",m,!0);var g={chid:d,media_id:l,cancelCbk:function(){return t.handleUICancel(u,d,l)},muteCbk:function(){}};o.showScreenShareMaking(u,g),p||s.screenEndFromBrowserUI(function(){return t.handleUIEnd({type:u,id:l,chatid:d})}),c.triggerIconCheck(d)},i.prototype.startCallFailure=function(){},i.prototype.addRemoteStream=function(e,t){var i=this;try{var n=t.type,a=t.mid,o=t.chid,r=e.stream;e.streams&&(r=e.streams[0]),this.container.uiHandler.playScreenShareStream({stream:r,chid:o,mid:a,endCbk:function(){return i.handleUIEnd({type:n,id:a,chatid:o})}})}catch(e){}},i.prototype.clearData=function(e){try{var t=this.container.commonImpl,i=e.chatid||e.chid,n=e.id||e.mid;this.closePeerConn(e),t.removeCredential(n),t.checkAVIcon(i),t.clearCallDetails(i,n),t.getActiveCallData()&&t.getActiveCallData()==i&&!t.getCallStatusByChid(i)&&t.removeActiveCallData(),t.removeIncomingRequestData(i),t.stopNotificationSound(),t.checkAndPlayNotification(),t.getCallStatusByChid(i)||t.removeActiveTab()}catch(e){}},i.prototype.closePeerConn=function(e){var t=e.chatid,i=e.type,n=e.id;try{var a=this.container.dataHandler.get(t+"_peer");if(!a)return void this.clearMediaPermision(i);a[n].closeConnection(),delete a[n],this.clearMediaPermision(i)}catch(e){}},i.prototype.clearMediaPermision=function(e){this.container.MediaPermission.closeStreamByType(e)},i.prototype.handleUIEnd=function(e){var t=e.type,i=e.id,n=e.chatid,a=this.container,o=a.uiHandler,r=a.detailsHandler;a.commonImpl.makeCallEnd(t,i),o.updateCallInvitationState(t,{chid:n,media_id:i},"ended"),r.clearPlayer(),this.clearData(e),r.handleCallEnded({type:t,chid:chid})},i.prototype.callConnected=function(e){this.screenShareConnectedUI(e)},i.prototype.screenShareConnectedUI=function(e){var t=this,i=e.chid,n=e.type,a=e.mid,o=e.isUpStream,r=this.container,s=r.commonImpl,c=r.uiHandler,d=s.getCallStatusByChid(i)[a].mediarequest,l=s.getEligibleMediaAction(e.chid,n),u={chid:i,media_id:a,eligibleOption:l,isViewing:o&&d||!o&&!d,muteCbk:function(){return function(){}},callEndCbk:function(){return t.handleUIEnd({chatid:e.chid,type:n,id:a})}};s.updateCallStatus(i,a,"connected"),c.updateCallInvitationState("screen_share",u,"connected")},i.prototype.callBackAction=function(e,t){({postDebugLog:this.postDebugLog.bind(this)})[e](t)},i.prototype.init=function(){this.implConstants={postDebugLog:"postDebugLog"}},i.prototype.postDebugLog=function(e){this.container.detailsHandler.sendDebugLogger(e,null,null,!0)},i.prototype.handleUICancel=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.uiHandler,r=n.detailsHandler,s={chid:t,media_id:i,type:e};a.makeCallCancel(e,i),this.clearData({type:e,chatid:t,id:i}),o.updateCallInvitationState("screen_share",s,"cancelled"),r.handleCallCancelled({type:e,chid:t})},i.prototype.swapScreenShare=function(e,t){void 0===t&&(t={});var i=e.chatid,n=e.id,a=this.container,o=a.screenShareImpl,r=a.commonImpl,s=this.getScreenShareType(i,n);o.handleUIEnd({type:"screen_share",id:n,chatid:i}),r.removeActiveCallData();var c={chatid:i,mode:"visitor",type:"screen_share",mediainvitation:!0,mediarequest:!0};s&&(c.mediarequest=!1,c.mediainvitation=!1);var d=Object.assign({},c,t);o.startScreenShare(d)},i.prototype.getScreenShareType=function(e,t){var i=this.container.commonImpl.getCallStatusByChid(e),n=i&&i[t];if(!i||!n)return-1;var a=n.mediarequest,o="upstream"==n.host;return o&&a?1:o&&!a||!o&&a?0:o||a?void 0:1},i.prototype.endOngoingCall=function(e,t){var i=this.container,n=i.dataHandler,a=i.uiHandler,o=i.commonImpl,r=n.get(e+"_peer");if(r)for(var s in r){var c=r[s];a.updateCallInvitationState(c.type,{chid:e,media_id:c.mid},"ended"),o.makeCallEnd(c.type,c.mid),this.clearData(c),delete r[s]}else{o.makeCallEnd("screen_share",t),this.clearData(peer)}o.removeActiveCallData(e)},i.prototype.isScreenShareSupported=function(){};function n(e){((this.container=e).commonImpl=this).reloadCheck=!1}n.prototype.setCredential=function(e){var t=e.id,i=e.type,n={mid:t,credential:e.credentials,chid:e.chatid,type:i};this.container.dataHandler.set(t+"_credential",n)},n.prototype.removeCredential=function(e){this.container.dataHandler.remove(e+"_credential")},n.prototype.constructURL=function(e,t){var i="media";return e&&(i+="/"+t+"/"+e),i},n.prototype.sendOffer=function(e){e.chid;var t=e.description,i=e.mid,n=(e.type,this.container),a=n.detailsHandler,o=n.ajaxHandler,r=this.constructURL("offer",i),s={};s.session=a.toJSON(t),o.post(r,s,null,null)},n.prototype.sendAnswer=function(e){e.chid;var t=e.description,i=e.mid,n=(e.type,this.container),a=n.detailsHandler,o=n.ajaxHandler,r=this.constructURL("answer",i),s={};s.session=a.toJSON(t),o.post(r,s,null,null)},n.prototype.sendCandidate=function(e){var t=e.candidates,i=(e.chid,e.mid),n=(e.type,this.constructURL("candidates",i)),a={};a.candidates=t,this.container.ajaxHandler.post(n,a,null,null)},n.prototype.setActiveCallData=function(e){this.container.dataHandler.set("active_call",e,!0)},n.prototype.getActiveCallData=function(){return this.container.dataHandler.get("active_call",!0)},n.prototype.removeActiveCallData=function(){this.container.dataHandler.remove("active_call",!0)},n.prototype.setCallStatus=function(e,t,i,n,a,o,r,s){void 0===s&&(s=!1);var c={chid:e,id:t,type:i,callType:n,callStatus:a,mediarequest:o,host:r,isdirectcall:s},d=this.getCallStatusByChid(e)||{};d[t]=c,this.container.dataHandler.set(e+"_call_status",d,!0)},n.prototype.getCallStatusByChid=function(e){return this.container.dataHandler.get(e+"_call_status",!0)},n.prototype.getAcitveMediaTypes=function(){var e=this.container.dataHandler.get("active_call",!0),t=this.getCallStatusByChid(e);return t?Object.values(t).map(function(e){return e.type}):[]},n.prototype.updateCallStatus=function(e,t,i){var n=this.container.dataHandler,a=n.get(e+"_call_status",!0);a&&a[t]&&(a[t].callStatus=i),n.set(e+"_call_status",a,!0)},n.prototype.checkAVIcon=function(e){var t=this.container,i=t.dataHandler,n=t.uiHandler;i.get("active_call",!0)==e&&n.enableOutingCallUI()},n.prototype.checkNetwork=function(t,i,e){var n=this;void 0===e&&(e=!1);var a=this.container,o=a.dataHandler,r=a.uiHandler,s=o.get(t+"_peer")[i],c=s.type;s.reconnectInterval=setTimeout(function(){var e=document.createElement("IMG");e.src=_MEDIASERVERURL+"/images/spacer.gif?nocache="+(new Date).getTime(),e.onload=function(){s.iceRestart=!0,s.isUpStream&&s.createOffer(),n.updateAcceptedTimeForMediaStats(Date.now(),i)},e.onerror=function(){return n.checkNetwork(t,i,!0)}},5e3),s.reconnectEndTimer||(s.reconnectEndTimer=setTimeout(function(){n.container[c+"Impl"].endOngoingCall(t),clearTimeout(s.reconnectInterval),s.reconnectEndTimer=null},3e4)),e||r.updateCallInvitationState(c,{chid:t,media_id:i},"reconnecting")},n.prototype.clearNetworkTimer=function(e){clearTimeout(e.reconnectEndTimer),clearTimeout(e.reconnectInterval)},n.prototype.clearCallDetails=function(e,t){var i=this.container.dataHandler,n=i.get(e+"_call_status",!0);delete n[t],0<Object.keys(n).length?i.set(e+"_call_status",n,!0):i.remove(e+"_call_status",!0),i.remove(t+"_credential")},n.prototype.updateCommonData=function(){},n.prototype.getCommonData=function(){},n.prototype.makeCallMissed=function(e,t,i){this.makeCallHelper("miss",e,t,i)},n.prototype.makeCallAccept=function(e,t,i){this.makeCallHelper("accept",e,t,i)},n.prototype.makeCallCancel=function(e,t,i){this.makeCallHelper("cancel",e,t,i)},n.prototype.makeCallEnd=function(e,t,i){this.makeCallHelper("end",e,t,i)},n.prototype.makeCallReject=function(e,t,i){this.makeCallHelper("reject",e,t,i)},n.prototype.makeCallConnected=function(e){var t=e.callerType,i=e.latency,n=e.lsid,a=e.mediaid,o=e.reconcount,r=e.wmsid,s=this.constructURL("connected",a),c={latency:i,reconcount:o,callerType:t,lsid:n};r&&(c.wmsid=r),this.container.ajaxHandler.post(s,c,null,null)},n.prototype.makeCallHelper=function(e,t,i,n){var a=this.container,o=a.commonImpl,r=a.ajaxHandler,s=o.constructURL(e,i);r.post(s,{},n)},n.prototype.updateIncomingRequestData=function(e){var t={},i=e.chatid,n=e.type,a=e.id,o=this.container.dataHandler,r=o.get("media_inv")||[];t[i]={type:n,id:a},r.push(t),o.set("media_inv",r,!0)},n.prototype.removeIncomingRequestData=function(e){var t,i=this.container.dataHandler,n=i.get("media_inv",!0);for(t in n){var a=n[t];Object.keys(a)[0]==e&&n.splice(t,1)}n&&(0==n.length?this.deleteIncomingRequestKey():i.set("media_inv",n,!0))},n.prototype.getIncomingRequest=function(){return this.container.dataHandler.get("media_inv",!0)},n.prototype.deleteIncomingRequestKey=function(){this.container.dataHandler.remove("media_inv",!0)},n.prototype.getMediaDataByChidAndType=function(e){var t,i=e.chatid,n=e.type,a=this.getCallStatusByChid(i);for(t in a){var o=a[t];if(o.type==n)return o}return null},n.prototype.endCallByChid=function(c,d){var l=this;try{var e,u=this.getCallStatusByChid(c),t=this.container,p=t.detailsHandler,h=t.uiHandler,m=t.commonImpl,g=t.dataHandler;for(e in u)!function(e){var t=u[e],i=t.id,n=t.type,a=t.callStatus,o=t.isdirectcall,r=l.container[n+"Impl"],s={chid:c,media_id:i,type:n};"connected"==a?(r.endOngoingCall(c,i,d||function(){return o&&p.endSession(c)}),h.updateCallInvitationState(n,s,"ended")):"connected"!=a&&"incoming"==t.callType?(o||m.makeCallReject(n,i,d),h.updateCallInvitationState(n,s,"rejected"),o&&r.handleUIApiReject(n,c,i)):"connected"!=a&&"outgoing"==t.callType&&(clearTimeout(g.get(i+"_waiting_timer")),m.makeCallCancel(n,i,d),h.updateCallInvitationState(n,s,"cancelled")),s.id=i,r.clearData(s)}(e)}catch(e){}},n.prototype.checkOnGoingCall=function(){try{this.checkAndClearDataOnRefresh()}catch(e){}},n.prototype.checkAndClearDataOnRefresh=function(){var t=this;Object.keys(localStorage).forEach(function(e){return e.match(/SiqMedia_/g)&&t.container.dataHandler.remove(e.replace("SiqMedia_",""),!0)})},n.prototype.setActiveTab=function(){this.container.dataHandler.set("media_active",!0)},n.prototype.getActiveTab=function(){return this.container.dataHandler.get("media_active")||!1},n.prototype.removeActiveTab=function(){this.container.dataHandler.remove("media_active")},n.prototype.currentUserBrowserSupportSS=function(){var e=this.container.MediaDetails,t=e.getPlatform();return!!/linux|Microsoft Windows|Mac OS|MacIntel|Win32|Win64/i.test(t)&&e.checkBrowserSupported()},n.prototype.checkIncomingCallAllowed=function(e){var t=e.chatid,i=(e.id,e.type);if(this.getMediaDataByChidAndType({chatid:t,type:i}))for(var n=this.container.dataHandler.get(t+"_peer"),a=n&&Object.keys(n).length||0,o=0;o<a;o++){return"connected"!=n[Object.keys(n)[o]].connectionStatus?(this.endCallByChid(t),!1):!0}return!1},n.prototype.setMediaStatsDetail=function(e){var t=e.acceptedTime,i=e.type,n=e.mediaid,a={acceptedTime:t,type:i,mediaid:n,reconnectCount:e.reconnectCount,lsid:e.lsid,callerType:e.callerType};this.container.dataHandler.set(n+"_connectionstats",a)},n.prototype.updateMediaStatsDetail=function(e){var t=e.connectedTime,i=e.isreconnected,n=e.mediaid,a=this.container.dataHandler,o=a.get(n+"_connectionstats");o.connectedTime=t,o.reconnectCount=i?o.reconnectCount+1:o.reconnectCount,a.set(n+"_connectionstats",o)},n.prototype.updateAcceptedTimeForMediaStats=function(e,t){var i=this.container.dataHandler,n=i.get(t+"_connectionstats");n.acceptedTime=e,i.set(t+"_connectionstats",n)},n.prototype.getConnectedStatsDetail=function(e){var t=this.container,i=t.dataHandler,n=t.detailsHandler,a=i.get(e+"_connectionstats"),o={latency:a.connectedTime-a.acceptedTime,reconcount:a.reconnectCount,callerType:a.callerType,lsid:a.lsid,mediaid:e};return n.isEmbed()&&(o.wmsid=n.getVisitorWMSID()),o},n.prototype.clearConnectedStatsDetail=function(e){this.container.dataHandler.remove(e+"_connectionstats")};var a=function(e){function t(){e.apply(this,arguments),this.isDirectCallAllowed=!1}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.audioIconStatus=function(e,t,i){void 0===i&&(i=1);var n=this.container,a=n.detailsHandler,o=n.commonImpl.getMediaDataByChidAndType({chatid:e,type:"audio"})||!1,r={not_group_chat:!a.isGroupConversation(e),not_bot:!a.isAttenderBot(e),ongoing_chat:a.isChatExist(e),audiocall_enabled:a.isAudioCallEnabled(),current_plan_allowed:a.isPlanAllowed(),is_secure:a.isSecureConnection(),is_proactive_chat:!a.isProactiveChat(e),live_chat_window:a.isliveChatWindow(),isFacebookIntegration:!a.isFaceBookIntegration()},s={ongoing_call_current_chat:o,incoming_call_notification:a.hasIncomingCall(e)},c={1:["not_group_chat","not_bot","ongoing_chat","audiocall_enabled","current_plan_allowed","is_secure","is_proactive_chat","live_chat_window","isFacebookIntegration"]}[i].map(function(e){return r[e]}).reduce(function(e,t){return e&&t},!0),d={1:["ongoing_call_current_chat","incoming_call_notification"]}[i].map(function(e){return s[e]}).reduce(function(e,t){return e||t},!1);t(e,c?d?"disable":"show":"hide")},t.prototype.onstarted=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.MediaPermission,o=i.detailsHandler,r=i.uiHandler,s=i.dataHandler;if(e.data.error&&"5001"==e.data.error.code)return n.removeActiveTab(),n.removeActiveCallData(),a.closeAllStream(),o.hideAudioCall(),o.stopNotifSound(),!0;var c=f(f(e.data.msg).media),d=c.chatid,l=c.id,u=c.type,p=c.mediaRequest;this.iconClicked={};s.set(l+"_waiting_timer",setTimeout(function(){n.makeCallMissed(u,l),t.clearData({type:u,chatid:d,id:l}),r.updateCallInvitationState(u,{chid:d,media_id:l},"missed")},6e4)),n.setCallStatus(d,l,u,"outgoing","ringing",p,"upstream"),n.setActiveCallData(d);var h={chid:d,media_id:l,cancelCbk:function(){t.handleUICancel(u,d,l)},muteCbk:function(){return t.toggleMute()}};r.handleAudioCallInitiate(u,h),o.triggerIconCheck(d)},t.prototype.startApiDirectCall=function(e){var t=this,i=(e.conversationType,e.successCbk),n=this.container,a=n.uiHandler,o=n.MediaPermission,r=n.commonImpl,s=function(){clearTimeout(c)},c=setTimeout(function(){s=a.mediaPermissionUI()},3e3);return o.getAudioStream(function(){s(),t.directCallMediaPermissionSuccess(i)},function(){return t.directCallMediaPermissionFailure(function(){return s()})}),r.setActiveTab(),this.isDirectCallAllowed=!0},t.prototype.directCallMediaPermissionSuccess=function(e){var t=this;try{var i=this.container.detailsHandler;i.playNotifSound({tone:"outgoingcall",duration:60}),this.isDirectCallAllowed=!0;e(function(){return t.toggleMute()})}catch(e){}},t.prototype.directCallMediaPermissionFailure=function(e){var t=this.container.uiHandler;return e(),t.mediaPermissionUnlock(),t.directCallCancelled(),!1},t.prototype.handleUIApiReject=function(e,t,i){this.handleUIReject(e,t,i),this.container.detailsHandler.initMissedChat(chatid,"CALLENDED","2",!0)},t.prototype.handleUIApiCallEnd=function(e,t,i){var n=this.container,a=n.commonImpl,o=n.detailsHandler;a.makeCallEnd(t,i,function(){return o.endSession(e)}),this.handleCallEnd({chatid:e,type:t,id:i}),localStorage.removeItem("siq_directcall")},t.prototype.onDirectCallStarted=function(e){var t=this,i=this.container,n=i.commonImpl,a=i.detailsHandler,o=i.uiHandler,r=i.dataHandler,s=e.type,c=e.id,d=e.chatid,l=e.mediaRequest;n.setCredential(e);r.set(c+"_waiting_timer",setTimeout(function(){n.makeCallMissed(s,c),t.clearData({type:s,chatid:d,id:c}),a.initMissedChat(d,"CALLENDED","2",!0),o.updateCallInvitationState(s,{chid:d,media_id:c},"missed")},6e4)),n.setCallStatus(d,c,s,"outgoing","ringing",l,"upstream",!0),n.setActiveCallData(d);function u(){n.makeCallCancel(s,c,function(){return a.initMissedChat(d,"CALLENDED","2",!0)}),o.updateCallInvitationState("audio",{chid:d,media_id:c},"cancelled"),localStorage.removeItem("siq_directcall"),t.clearData({type:s,chatid:d,id:c})}function p(){return t.toggleMute()}a.triggerIconCheck(d);setTimeout(function(){return o.handleAudioCallInitiate(s,{chid:d,cancelCbk:u,muteCbk:p,media_id:c,isDirectCall:!0})},500),clearTimeout(a.getChatWinObjById(d).waitTimer),localStorage.setItem("siq_directcall",v({chid:d,media_id:c,type:s,status:"outgoing"}))},t.prototype.startAudioCallAgain=function(e){var t,i,n=this.container,a=n.detailsHandler,o=n.audioImpl;this.hasIncommingCall(e)||(i={type:"audio",chatid:(t=a.getChatWinObjById(e)).chatID,mode:"visitor",mediarequest:!0,mediainvitation:!0,wmsid:$Support.EmbedObj.vwmsid,lsuid:t.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid},o.startAudioCall(i))},t.prototype.pushVoiceToServer=function(e){var t={},i=$Support.getAjaxURL("makeav",dext),n=this.container.detailsHandler.getChatWinObjById(e);t.action="voicerec",t.wmsid=$Support.EmbedObj.vwmsid,t.chid=n.chatID,t.cuid=n.visitorID,t.lsuid=n.attender,$.ajax({url:i,data:t,type:"POST"})},t}(e),r=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.screenshareIconStatus=function(e){var t=e.chid,i=e.callback,n=e.type;void 0===n&&(n=1);var a=this.container.detailsHandler,o={not_group_chat:!a.isGroupConversation(t),not_bot:!a.isAttenderBot(t),ongoing_chat:a.isChatExist(),audiocall_enabled:a.isScreenShareAllowed(t),current_plan_allowed:a.isPlanAllowed()},r={sharescreenAllowed:!a.isShareScreenAllowed(t)},s={1:["not_group_chat","not_bot","ongoing_chat","audiocall_enabled","current_plan_allowed"]}[n].map(function(e){return o[e]}).reduce(function(e,t){return e&&t},!0),c={1:["sharescreenAllowed"]}[n].map(function(e){return r[e]}).reduce(function(e,t){return e&&t},!0);d(i)&&i(t,s?c?"disable":"show":"hide")},t.prototype.isScreenShareAllowed=function(e){var t=e.chatid,i=this.container,n=i.commonImpl,a=i.constants,o=i.detailsHandler,r=i.uiHandler,s=!0,c="",d="";return!n.getMediaDataByChidAndType({chatid:t,type:a.screen_share})&&(o.isSecureConnection()?o.isShareScreenAllowed(t)||(s=!1,d="siqMedia: screen share Failed screen share not allowed | chid - "+t):(s=!1,c=o.I18N("av.info.insecuredwebsite"),d="siqMedia: screen share Failed Visitor not in secure connection | chid - "+t),!s&&c&&(r.showDialog({desc:c,buttons:{accept:{text:"common.ok",callback:function(){return null}}}}),callBackAction(implConstants.postDebugLog,d)),s)},t}(i),s=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t}(t),c=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype.checkAndUpdateUIForApi=function(){},t.prototype.playMediaNotificationSound=function(e){this.container.detailsHandler.playNotifSound(e)},t.prototype.stopNotificationSound=function(){this.container.detailsHandler.stopNotifSound()},t.prototype.showDesktopNotif=function(){},t.prototype.startApiCall=function(e){var t=e.conversationtype,i=this.container.constants[t]+"Impl";return this.container[i].startApiDirectCall(e)},t.prototype.getEligibleMediaAction=function(e){var t=this.container,i=t.constants,n=t.detailsHandler,a=t.commonImpl,o=n.isAudioCallEnabled(),r=(n.isScreenShareEnabled(),a.getCallStatusByChid(e)),s=new Array;o&&s.push(i.audio),s.push(i.screen_share),s.push(i.video);for(var c in r)!function(e){var t=r[e];s=s.filter(function(e){return![t.type].includes(e)})}(c);return s},t.prototype.checkAndPlayNotification=function(){},t.prototype.getEligibleMediaAction=function(e){var t=this.container,i=t.constants,n=t.detailsHandler,a=t.commonImpl,o=n.isAudioCallEnabled(),r=(n.isScreenShareEnabled(),a.getCallStatusByChid(e)),s=new Array;o&&s.push(i.audio),s.push(i.screen_share),s.push(i.video);for(var c in r)!function(e){var t=r[e];s=s.filter(function(e){return![t.type].includes(e)})}(c);return s},t.prototype.getFailureMessage=function(e){var t=null;switch(e.name){case"NotFoundError":case"DevicesNotFoundError":t=LSResource.getRealValue("av.info.microphone.notavailable");break;case"SourceUnavailableError":case"PermissionDeniedError":case"SecurityError":case"NotAllowedError":default:t=LSResource.getRealValue("av.info.microphone.blocked")}return t},t.prototype.sendMediaStats=function(e,t){var i=e.msg,n=((i?i.media:null)||e).id,a={};e.statcode&&(a.statcode=e.statcode),a.description=t;var o="stats/"+n+"/media";this.container.ajaxHandler.post(o,a,null,null)},t}(n);function y(e,t){for(var i=[],n=arguments.length-2;0<n--;)i[n]=arguments[n+2];return{tag:e,props:t||{},children:i}}function h(e,t){if(void 0===t&&(t={}),-1!=["number","string","undefined"].indexOf(typeof e))return document.createTextNode(e);var i=document.createElement(e.tag);p(i,e.props,t);for(var n=0;n<e.children.length;n++)i.appendChild(h(e.children[n],t));return i}function p(e,t,i){if(!e.skipattr)for(var n in t)"skipattr"==n?e.skipattr=!0:"on"==n.slice(0,2)?function(e,t,i){t=t.slice(2).toLowerCase(),e._listeners&&e._listeners[t]||e.addEventListener(t,function(e){return this._listeners[e.type](e)},!1);(e._listeners||(e._listeners={}))[t]=i}(e,n,t[n]):"ref"===n.slice(0,3)?i.refs[t[n]]=e:"html"===n.slice(0,4)?e.innerHTML=t[n]:"video"!=e.tagName.toLowerCase()||e[n]?n&&void 0!==t[n]&&$(e).attr(n)!=t[n]&&e.setAttribute(n,t[n]):e[n]=t[n]}Element.prototype.zsiqdrag=function(e,r){var s=0,c=0,d=this,l=!1;function u(e){var t=getComputedStyle(d),i=parseInt(t.getPropertyValue("left"))||0,n=parseInt(t.getPropertyValue("top"))||0;if(i<0||n<0)return i<0&&(d.style.left="0px"),n<0&&(d.style.top="0px"),l=!1,void(r?window.parent:window).removeEventListener("mousemove",u);var a=parseInt(t.getPropertyValue("right"))||0,o=parseInt(t.getPropertyValue("bottom"))||0;if(a<0||o<0)return a<0&&(d.style.left=i+a+"px"),o<0&&(d.style.top=n+o+"px"),l=!1,void(r?window.parent:window).removeEventListener("mousemove",u);d.style.left=e.pageX-s+"px",d.style.top=e.pageY-c+"px"}this.addEventListener("mousedown",function(e){l=!0;var t=getComputedStyle(d),i=parseInt(t.getPropertyValue("left"))||0,n=parseInt(t.getPropertyValue("top"))||0;s=e.pageX-i,c=e.pageY-n,(r?window.parent:window).addEventListener("mousemove",u)}),this.addEventListener("mouseup",function(e){!0===l&&(l=!1,(r?window.parent:window).removeEventListener("mousemove",u))})};function o(){this.embed=SiqAVRouter.container.detailsHandler.isEmbed(),this.reRender()}o.prototype.updateState=function(e){e&&(this.state=e);try{this.reRender()}catch(e){}},o.prototype.reRender=function(){var e;this.dom&&1==this.dom.nodeType?this.dom=function e(t,i,n,a){var o,r,s,c=t;if(t)if(o=t,(s=-1!=["string","number"].indexOf(typeof(r=i)))||3==o.nodeType?s&&3==o.nodeType&&o.textContent==r:o.tagName.toLowerCase()==r.tag.toLowerCase()){if("object"==typeof i&&1==t.nodeType){var d=Math.max(t.childNodes.length,i.children.length),l=Array.from(t.childNodes);p(t,i.props||{},a);for(var u=0;u<d;u++)e(l[u],i.children[u]?i.children[u]:"",t,a)}}else c=h(i,a),$(t).replaceWith(c);else i&&n.append(h(i,a));return c}(this.dom,this.render(),this.placeholder,this):(e=h(this.render(),this),this.dom&&$(this.dom).replaceWith(e),this.dom=e,this.embed?!this.disableDrag&&e.zsiqdrag&&e.zsiqdrag(e,this.frameout):this.disableDrag||1!=e.nodeType||$(e).draggable({containment:"window",scroll:!1})),this.dom&&!this.dom.parentNode&&(this.placeholder_prepend?$(this.placeholder).prepend(this.dom):$(this.placeholder).append(this.dom))},o.prototype.destroy=function(){$(this.dom).remove()};var l=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.screenShareAllowed=i.detailsHandler.isScreenShareAllowed(),n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.destroy=function(){this.ssTimer&&clearInterval(this.ssTimer),this.audioTimer&&clearInterval(this.audioTimer),$(this.dom).remove()},e.prototype.canStartSS=function(){return!this.state.screen_share},e.prototype.getUI=function(){var e=this.state,t=e.audio,i=e.screen_share;return!i||"sharing"!=i.type||t&&"connected"!=t.status?t&&(!i||"viewing"!=i.type||"viewing"==i.type&&"connected"!=t.status)?this.getAudioCallUI():"":this.getScreenShareUI()},e.prototype.getAudioCallBtns=function(){var e=this,t=this.state,i=t.handler,n=(t.name,t.url,t.screen_share),a=t.audio,o=t.chid,r=a.mute,s=a.status,c=this.container.detailsHandler,d="invited"==s,l="connected"==s,u="requested"==s,p="connecting"==s,h=c.isScreenShareAllowed()&&c.isShareScreenAllowed(o),m=n&&("connected"==n.status?"end":"cancel"),g="connected"==s?"end":"cancel";return y("div",{class:"cal_actns"},h&&!n&&l?y("div",{title:I("screenshare"),class:"sqico-screenshare",onclick:function(){return e.container.uiHandler.shareScreen(o)}}):"",n&&"sharing"==n.type?y("div",{title:I(m),class:"sqico-ssend",onclick:function(){return i(o,"screen_share","reject")}}):"",l||u||p?y("div",{title:I(r?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(r?"muteaudio":"microphone"),onClick:function(){return i(o,"audio","mute")}}):"",d?y("div",{title:I("accept"),class:"sqico-call",onclick:function(){return i(o,"audio","accept")}}):"",y("div",{title:I(g),class:"sqico-call reject-cal",ref:"audio_call_reject",onclick:function(){return i(o,"audio","reject")}}))},e.prototype.getScreenShareBtns=function(){var e=this.state,t=e.handler,i=e.screen_share,n=e.audio,a=e.chid,o=i&&("connected"==i.status?"end":"cancel"),r=n&&("connected"==n.status?"end":"cancel");return y("div",{class:"cal_actns"},y("div",{title:I(o),class:"sqico-ssend",onclick:function(){return t(a,"screen_share","reject")}}),n&&"connected"==n.status?y("div",{title:I(n.mute?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(n.mute?"muteaudio":"microphone"),onClick:function(){return t(a,"audio","mute")}}):"",n&&"connected"==n.status?y("div",{title:I(r),class:"sqico-call reject-cal",ref:"audio_call_reject",onclick:function(){return t(a,"audio","reject")}}):"")},e.prototype.getAudioCallUI=function(){var e=this.state,t=(e.handler,e.name),i=e.url,n=(e.screen_share,e.audio),a=e.chid,o=(n.mute,n.status),r="invited"==o,s="requested"==o,c=i&&i(n.media_id)?y("img",{src:i(n.media_id,a),draggable:"false"}):y("em",{class:"sqico-person"});return y("div",{class:"zsembd_audiocl textC"},y("nav",{class:"zsembd_usrprof "+(r||s?"zsembd_calrng":"")},y("div",{class:" sqico-personimg"}," ",c," ")),y("span",{class:"zsembd_adodesc txtelips"},t(a),y("em",{class:"txtelips font14",ref:"audio_call_info"}," ",w(this.state)," ")),this.getAudioCallBtns())},e.prototype.getScreenShareUI=function(){var e=this.state,t=(e.handler,e.name),i=e.url,n=e.screen_share,a=(e.audio,e.chid),o=n.status,r=i&&i(n.media_id)?y("img",{src:i(n.media_id,a),draggable:"false"}):y("em",{class:"sqico-person"});return y("div",{class:"zsembd_audiocl textC"},y("nav",{class:"zsembd_usrprof "+("invited"==o?"zsembd_calrng":"")},y("div",{class:" sqico-personimg"}," ",r," ")),y("span",{class:"zsembd_adodesc txtelips"},t(a),y("em",{class:"txtelips font14",ref:"audio_call_info"}," ",R(this.state,!1)," ")),this.getScreenShareBtns())},e.prototype.render=function(){return this.state.isDirectCall||document.querySelector("#call_Busy")?"":this.getUI()},e}(o);function u(e,t,i){void 0===i&&(i=!0);var n={type:"audio",mode:"visitor",mediarequest:!0,mediainvitation:!0},a=e.detailsHandler.getChatWinObjById(t);i?$.extend(n,{chatid:a.chatID,wmsid:$Support.EmbedObj.vwmsid,lsuid:a.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid}):$.extend(n,{chatid:t}),e.audioImpl.startAudioCall(n)}var m=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.init(),n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.init=function(){this.fullscreen=!1,this.showcntrl=!1,this.frameout=!0,this.switchCbk=this.switchFullscreen.bind(this)},e.prototype.switchFullscreen=function(){this.fullscreen=!this.fullscreen,this.fullscreen?window.addEventListener("keyup",this.switchCbk):window.removeEventListener("keyup",this.switchCbk),this.reRender()},e.prototype.getAudioCallBox=function(){var e=this.state,t=e.audio,i=e.handler,n=e.chid,a=e.name,o=e.url,r=this.embed?"siqico":"sqico",s=t&&("connected"==t.status?"end":"cancel");return y("div",{class:"zsiq_calldtl"},y("span",null,o&&o(t.media_id)?y("img",{src:o(t.media_id,n),class:"siquserimg"}):y("em",{class:r+"-user"}),y("em",{class:"zsiq_caller txtelips"},a(n))),y("span",null,w(this.state),t&&"connected"==t.status?y("em",{title:I(t.mute?"unmute":"mute"),class:r+"-"+(t.mute?"unmute":"mute")+" zsiq_ctrlico",onClick:function(){return i(n,"audio","mute")},"data-type":"mic"}):"",t&&"invited"==t.status?y("em",{title:I("accept"),class:r+"-end zsiq_vend zsiq_ctrlico zsiq_callin",onclick:function(){return i(n,"audio","accept")}}):"",y("em",{title:I(s),class:r+"-end zsiq_vend zsiq_ctrlico",onclick:function(){return i(n,"audio","reject")}}),y("em",null)))},e.prototype.showCntrl=function(){var e=this;this.showcntrl=!0,clearTimeout(this.showCntrlTimer),this.showCntrlTimer=setTimeout(function(){e.showcntrl=!1,e.reRender()},1500),this.__swapHandlerClickCbk(),this.reRender()},e.prototype.__swapHandlerClickCbk=function(){this.swapOptions&&($(this.swapOptions).remove(),this.swapOptions=null)},e.prototype.__swapHandler=function(e,n,t){function a(){return o.__swapHandlerClickCbk.call(o)}function i(e,t,i){n(e,t,i),a()}var o=this;if(this.swapOptions)return a();this.swapOptions=h(y("div",{class:"zsiqcalloptions",id:"calloptions",style:"left:"+(e.clientX-220)+";top:"+(e.clientY-65)+";height:65px;z-index:11111111111;",onMouseLeave:this.__swapHandlerClickCbk.bind(this)},y("div",{onClick:function(){return i(t,"screen_share","swap")}},LSResource.getRealValue("screenshare.sharemyscreen")),y("div",{onClick:function(){return i(t,"screen_share","reject")}},LSResource.getRealValue("screenshare.endscreen")))),this.placeholder.append(this.swapOptions)},e.prototype._SwapList=function(e,t,i){this.embed&&this.state.audio&&!this.fullscreen?this.__swapHandler(e,t,i):t(i,"screen_share","swap")},e.prototype.__callCbk=function(){u(this.container,this.state.chid,this.embed)},e.prototype.getScreenShareButtons=function(){var t=this,e=this.state,i=e.screen_share,n=e.audio,a=e.handler,o=e.chid,r=e.chatWinFocused,s=i.status,c=this.embed?"siqico":"sqico",d=i&&("connected"==i.status?"end":"cancel"),l=n&&("connected"==n.status?"end":"cancel"),u=this.container.detailsHandler.isAudioCallEnabled();return y("div",{class:"zsiq_vctrl zsiq_center"},"connected"==s?y("em",{title:I("swap"),class:c+"-swap zsiq_ctrlico",onClick:function(e){return t._SwapList(e,a,o)}}):"",this.embed&&!this.fullscreen&&n&&"connected"==n.status?y("em",{title:I(n.mute?"unmute":"mute"),class:c+"-"+(n.mute?"unmute":"mute")+" zsiq_ctrlico",onClick:function(){return a(o,"audio","mute")},"data-type":"mic"}):"",!this.embed&&!this.fullscreen&&r||this.state.audio||!u?"":y("em",{title:I("call"),class:c+"-call zsiqpickup zsiq_ctrlico",onclick:this.__callCbk.bind(this)}),this.embed&&!this.fullscreen&&n?y("em",{title:I(l),class:c+"-end zsiq_vend  zsiq_ctrlico",onclick:function(){return a(o,"audio","reject")}}):"",!this.fullscreen&&n&&this.embed?"":y("em",{title:I(d),class:c+"-ssend zsiq_vchat zsiq_ctrlico",onclick:function(){return a(o,"screen_share","reject")}}))},e.prototype.getUI=function(){var e=this.state,t=e.screen_share,i=e.audio,n=t.stream,a=t.timer,o=this.embed?"siqico":"sqico";return y("div",{class:"zsiq_video_main "+(this.fullscreen?"zsiq_maxvideo":"")+" "+(this.showcntrl||!a?"zsiq_showcntl":""),onMouseMove:this.showCntrl.bind(this),onMouseDown:this.__swapHandlerClickCbk.bind(this)},y("em",{class:o+"-maxicon zsiq_maxicon zsiq_center",onclick:this.switchFullscreen.bind(this)}),y("span",{class:"zsiq_vtime "+(a?"":"info"),id:"zsiqvideo_time"},R(this.state)),this.getScreenShareButtons(),y("video",{autoplay:!0,srcObject:n,className:"zsiq_video",id:"zsiqvideoviewer"}),this.fullscreen&&i?this.getAudioCallBox():"")},e.prototype.render=function(){var e=this.state.screen_share;return e&&"viewing"==e.type&&"requested"!=e.status?this.getUI():""},e}(o);function g(){var e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t={Chrome:"https://support.google.com/chrome/answer/2693767?hl=en",Firefox:"https://support.mozilla.org/en-US/questions/1168156",Opera:"https://help.opera.com/en/latest/web-preferences/#microphone",Safari:"https://support.apple.com/en-in/guide/safari/websites-ibrwe2159f50/mac"};t[e]&&window.open(t[e],"_blank")}function S(e,t,i,n,a){function o(){return $(c).remove()}function r(){var e=Recorder();a||(o(),$("body").append($Temp.getAudioRecordedUI(i(0,t),n(t)))),e.init(a,t)}var s,c;c=a?h(y("div",{class:"cal-wrap",id:"audiorec"},y("div",{class:"posrel dib-mid"},y("div",{class:"cal-widgt theme1 outcal"},y("div",{class:"posrel usr-imginfo"},y("div",{class:"cal-visimg "+((s=$Support.EmbedObj.clogo)?"":"sqico-user")},s?y("img",{src:s,draggable:"false"}):"")),y("div",{class:"cal-vstrdetl"},y("nav",{class:"cal-actvevstr elips font18"},LSResource.getRealValue("av.info.oprbusy")),y("p",{class:"cal-usrdesc elips"},LSResource.getRealValue("av.info.voicemsg"))),y("div",{class:"cal-optns posrel textR"},y("span",{onclick:r,class:"sqico-record bg-aaa"})))))):h(y("div",{class:"zsembd_audiocl textC",id:"call_Busy"},y("em",{class:"sqico-close",onClick:o}),y("nav",{class:"zsembd_usrprof"},y("div",{class:"'+perscls+' sqico-personimg"},y("div",{class:"cal-visimg "},y("img",{src:i&&i(0,t),draggable:"false"})))),y("span",{class:"zsembd_adodesc txtelips"},n(t),y("em",{class:"txtelips font14"},LSResource.getRealValue("av.info.userbusy"))),y("div",{class:"cal_actns"},y("div",{class:"call-record",title:LSResource.getRealValue("av.info.voicemessage"),onclick:r}),y("div",{class:"sqico-call",title:LSResource.getRealValue("av.info.callagain"),onclick:function(){return o()&&u(e,t)}})))),a?(CallImpl.isCallWithChat=!0,$("body").prepend(c)):(c.zsiqdrag(),$("body").append(c))}var _=function(n){function e(e,t,i){this.state=e,this.placeholder=t,this.refs={},this.container=i,this.disableDrag=!0,this.placeholder_prepend=!0,n.call(this)}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.getAudioCallStatusText=function(){var e=this.state.audio,t=e.status,i=e.timer;return{timer:i,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting"),initiated:LSResource.getRealValue("audiovideo.ringing"),mediapermission:LSResource.getRealValue("av.info.waitingformediapermission")}[i?"timer":t]||""},e.prototype.getUI=function(){var e=this.state,t=e.url,i=e.handler,n=e.name,a=e.chid,o=e.audio,r=o&&o.status,s=-1==["initiated","requested"].indexOf(r)&&t&&t(o.media_id,a)||$Support.EmbedObj.clogo,c="initiated"==r,d="mediapermission"==r;return y("div",{class:"cal-wrap",id:"audiocal"},y("div",{class:"posrel dib-mid"},y("div",{class:"cal-widgt theme1 outcal"},y("div",{class:"posrel usr-imginfo"},y("div",{class:"cal-visimg "},y("img",{src:s}))),y("div",{class:"cal-vstrdetl"},y("nav",{class:"cal-actvevstr elips font18"},n&&n(a)||""),y("p",{class:"cal-usrdesc elips"},this.getAudioCallStatusText())),y("div",{class:"cal-optns posrel textR"},y("span",{title:o&&I(o.mute?"unmute":"mute"),id:"audiocall_mute",class:"sqico-"+(o.mute?"muteaudio":"microphone")+" bg-aaa "+(d?"cmn_disable":""),onclick:function(){return d?"":i(a,"audio","mute")}}),y("span",{class:"sqico-call cal-rjct "+(c||d?"cmn_disable":""),id:"audiocall_outgoingend",onclick:function(){return c||d?"":i(a,"audio","reject")}})))))},e.prototype.render=function(){var e=this.state,t=e.isDirectCall,i=e.audio;e.status;return t&&i?this.getUI():""},e}(o);function I(e){var t={mute:LSResource.getRealValue("av.info.mute"),unmute:LSResource.getRealValue("av.info.unmute"),end:LSResource.getRealValue("common.end"),reject:LSResource.getRealValue("common.reject"),screenshare:LSResource.getRealValue("common.screenshare"),swap:LSResource.getRealValue("av.info.swap"),call:LSResource.getRealValue("av.info.call"),cancel:LSResource.getRealValue("common.cancel"),accept:LSResource.getRealValue("common.accept")};return t[e]?t[e]:""}function b(e,t){return"theme4"!=k()?"":y("div",{class:"thme-bgimg",style:"background-image:url("+("Comp"==e?$Support.EmbedObj.clogo:_SCHEMA+"://"+_EMBEDSERVERURL+"/"+_SCREENNAME+"/userimg/"+t.attenderimagefkey+"/photo.ls?nps=404")+")"})}function k(){return window.parent.$ZSIQWidget.getWidgetObject().calltheme||"theme1"}function w(e,t){void 0===t&&(t=!0);var i=e.audio,n=i.status,a=i.timer;return{timer:a,connected:LSResource.getRealValue("common.connected"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[a&&t?"timer":n]||""}function R(e,t){void 0===t&&(t=!0);var i=e.screen_share,n=i.status,a=i.timer;return{timer:a,connected:LSResource.getRealValue(t?"common.connected":"ss.info.viewing"),invited:LSResource.getRealValue("av.info.calling"),connecting:LSResource.getRealValue("av.info.connecting"),ended:LSResource.getRealValue("common.ended"),cancelled:LSResource.getRealValue("av.info.cancelled"),rejected:LSResource.getRealValue("common.declined"),requested:LSResource.getRealValue("audiovideo.ringing"),missed:LSResource.getRealValue("common.missed"),reconnecting:LSResource.getRealValue("common.reconnecting")}[a&&t?"timer":n]||""}function A(e){return SiqAVRouter.container.detailsHandler.getChatWinObjById(e)}function D(e,t){void 0===e&&(e=0);var i=A(t).attenderimagefkey,n=_SCHEMA+"://"+_EMBEDSERVERURL+"/"+_SCREENNAME+"/userimg/"+i+"/photo.ls?mid="+e;return i?n:$Support.EmbedObj.clogo}function T(e){return q[e]||""}function H(e){var t=this;this.container=e,this.invitations=null,this.ss_invitation={},this.states={},window.onbeforeunload=function(){var e=localStorage.getItem("siq_directcall");if((e=e&&JSON.parse(e))&&(e.is_refreshed=!0,localStorage.setItem("siq_directcall",JSON.stringify(e))),Object.keys(t.states).length)return""}}var q={};function M(){return SiqAVRouter.container.detailsHandler.isEmbed()?$(parent.document.body):$("body")}H.prototype.initiateHeadshot=function(e,t){this.states[e]||(this.states[e]={chid:e,isDirectCall:t},this.states[e].headshot=new l(this.states[e],$("body"),this.container),this.states[e].directCallUI=new _(this.states[e],$("body"),this.container))},H.prototype.updateCallInvitationState=function(e,t,i){var n={audio:{connecting:this.makeAudioCallConnecting,connected:this.makeAudioCallConnected,ended:this.makeAudioCallEnded,cancelled:this.makeAudioCallCancelled,rejected:this.makeAudioCallRejected,missed:this.makeAudioCallMissed,reconnecting:this.makeAudioReconnecting},screen_share:{connecting:this.makeScreenShareConnecting,connected:this.makeScreenShareConnected,ended:this.makeScreenShareEnded,cancelled:this.makeScreenShareCancelled,rejected:this.makeScreenShareRejected,missed:this.makeScreenShareMissed,reconnecting:this.makeScreenShareReconnecting}},a=n[e]&&n[e][i];try{a&&a.call(this,e,t)}catch(e){}},H.prototype.playScreenShareStream=function(e){var t=e.stream,i=(e.mid,e.endCbk,e.chid);this.initiateHeadshot(i);var n=this.states[i];n.screen_share=n.screen_share||{},$.extend(!0,n,{screen_share:{stream:t}});try{n.player||(n.player=new m(n,M(),this.container))}catch(e){}},H.prototype.handleAudioCallInvite=function(e,t){q[t.chid]=A(t.chid).attendername,"audio"==e?(this.showAudioCallInvitation(t),this.invitations=!0):"screen_share"==e&&this.showScreenShareInvitation(t),$(".zsembd_audiocl .sqico-close").click()},H.prototype.clearAudioCallInvite=function(e){var t=this.states[e];t&&t.audio&&delete t.audio,t&&t.screen_share&&delete t.screen_share,this.ss_invitation[e]&&$(this.ss_invitation[e]).remove(),this.__updateState(e),t&&this.__checkAndDestroyInstance(e)},H.prototype.showAudioCallInvitation=function(e){var t=e.chid,i=e.rejectCbk,n=e.acceptCbk,a=e.media_id;this.initiateHeadshot(t);var o=this.states[t];$.extend(!0,o,{handler:this.handleActionHandler.bind(this),name:T,url:D,chid:t,audio:{mute:!1,media_id:a,reject_cbk:i,accept_cbk:n,is_invited:!0,status:"invited"}}),this.__updateState(t),$Support.getParent().$ZSIQChatWindow.openChatWindow()},H.prototype.handleAudioCallInitiate=function(e,t){var i=this,n=t.chid,a=t.cancelCbk,o=t.muteCbk,r=t.media_id,s=t.isDirectCall;s?(this.states[n]=this.states.directcall,delete this.states.directcall):this.initiateHeadshot(n,s),q[n]=A(n).attendername;var c=this.states[n];$(".zsembd_audiocl .sqico-close").click(),$.extend(!0,c,{handler:this.handleActionHandler.bind(this),name:T,url:D,chid:n,audio:{mute:!!s&&c.audio.mute,media_id:r,reject_cbk:a,mute_cbk:function(){o(),$.extend(!0,c,{audio:{mute:!i.states[n].audio.mute}}),i.__updateState(n)},is_invited:!1,status:"requested"}}),this.__updateState(n)},H.prototype.initiateDirectCallUI=function(e){var t=this;void 0===e&&(e=null);function i(){e(),$.extend(!0,o,{audio:{mute:!t.states[n].audio.mute}}),t.__updateState(n)}var n="directcall";if(e){var a=this.states[n];return $.extend(!0,a,{audio:{mute:!1,mute_cbk:i,status:"initiated"}}),void this.__updateState(n)}$("#audiorec,#audiocal").remove(),this.initiateHeadshot(n,!0);var o=this.states[n];$.extend(!0,o,{audio:{mute:!1,mute_cbk:i,status:"mediapermission"}}),this.__updateState(n)},H.prototype.makeAudioCallConnecting=function(e,t){var i=this,n=t.chid,a=t.muteCbk,o=t.rejectCbk,r=(t.media_id,t.name,t.isDirectCall),s=this.states[n];EmbedSound.stop(),q[t.chid]=A(t.chid).attendername,$.extend(!0,s,{isDirectCall:r,audio:{mute_cbk:function(){a(),$.extend(!0,s,{audio:{mute:!i.states[n].audio.mute}}),i.__updateState(n)},reject_cbk:o,status:"connecting"}}),this.__updateState(n),r&&this.stopSoundNotification()},H.prototype.makeAudioCallConnected=function(e,t){t.media_id;var i=t.chid,n=t.callEndCbk,a=t.isDirectCall;EmbedSound.stop(),this.initiateHeadshot(i),this.ss_invitation[i]&&delete this.ss_invitation[i];var o=this.states[i];$.extend(!0,o,{isDirectCall:a,audio:{reject_cbk:n,status:"connected",connected_time:(new Date).getTime()}}),setTimeout(this.startTimer.bind(this,i,e),500),this.__updateState(i)},H.prototype.makeAudioReconnecting=function(e,t){this.__makeReconnecting(e,t)},H.prototype.makeAudioCallEnded=function(e,t){this.__callTerminate(e,t,"ended")},H.prototype.makeAudioCallCancelled=function(e,t){this.__callTerminate(e,t,"cancelled")},H.prototype.makeAudioCallRejected=function(e,t){this.states[t.chid].isDirectCall&&this.container.detailsHandler.initMissedChat(t.chid,"CALLENDED","2",!0),this.__callTerminate(e,t,"rejected")},H.prototype.makeAudioCallMissed=function(e,t){this.__callTerminate(e,t,"missed")},H.prototype.__recordSound=function(e,t){var i=this,n=this.container.detailsHandler.isChatExist(e);(1==this.container.detailsHandler.getSupportRepCount(e)&&n||t)&&($("#audiorec").remove(),S(this.container,e,D,T,t),this.__updateState(e),$(".zsembd_audiocl .sqico-close").on("click",function(){return i.__updateState(e)}))},H.prototype.__callTerminate=function(e,t,i){var n=this,a=t.chid,o=(t.media_id,t.isDirectCall),r=this.states[a],s=r.audio.is_invited;EmbedSound.stop(),r&&r.audio?(this.stopTimer(a,e),this.invitations=s?null:this.invitations,$.extend(!0,r,{audio:{status:i}}),setTimeout(function(){var e=r.isDirectCall;delete r.audio,n.__updateState(a),n.__checkAndDestroyInstance(a),s||-1==["rejected","missed"].indexOf(i)||n.__recordSound(a,e),e&&"ended"==i&&n.implementRatingUI(a),e&&"cancelled"==i&&n.directCallCancelled()},500),this.__updateState(a),o&&(this.stopSoundNotification(),clearTimeout(this.container.detailsHandler.getChatWinObjById(a).waitTimer))):r&&this.__checkAndDestroyInstance(a)},H.prototype.__checkAndDestroyInstance=function(e){try{var t=Object.keys(this.states[e]);0==["audio","screen_share"].filter(function(e){return-1!=t.indexOf(e)}).length&&delete this.states[e]}catch(e){}},H.prototype.showScreenShareInvitation=function(e){var t,i=e.chid,n=e.rejectCbk,a=e.acceptCbk,o=e.media_id;this.initiateHeadshot(i);function r(){$(t).remove(),a()}function s(e){void 0===e&&(e=!0),$(t).remove(),e&&n()}var c,d,l,u,p;d=(c={name:T,acceptHandler:r,rejectHandler:s,chid:i}).name,l=c.acceptHandler,u=c.rejectHandler,p=c.chid,t=h(y("div",{class:"zsiq_popup",id:"zsiqssconfirmbox"},y("div",{class:"zsiq_popupsub"},y("em",{class:"siqico-close zsiq_center",onClick:u}),y("em",{class:"siqico-screenshare zsiq_popuplogo"}),y("div",{class:"zsiq_popup_hdr"},LSResource.getRealValue("common.screenshare")),y("div",{class:"zsiq_popup_desc"},LSResource.getRealValue("screenshare.request.desc",d(p))),y("div",{class:"zsiq_popup_btn zsiq_center"},y("span",{class:"zsiq_center",id:"zsiqconfirmss",onClick:l},LSResource.getRealValue("common.share")),y("span",{class:"zsiq_center zsiq_cancelbtn",id:"zsiqdecliness",onClick:u},LSResource.getRealValue("common.decline")))))),$(M()).append(t),this.ss_invitation[i]={rejectHandler:s,acceptHandler:r,media_id:o,template:t}},H.prototype.showScreenShareMaking=function(e,t){var i=t.chid,n=t.cancelCbk,a=t.media_id;this.initiateHeadshot(i);var o=this.states[i],r=0==this.container.screenShareImpl.getScreenShareType(i,a)?"sharing":"viewing";$.extend(!0,o,{handler:this.handleActionHandler.bind(this),name:T,url:D,chid:i,screen_share:{media_id:a,reject_cbk:n,status:"requested",type:r}}),this.__updateState(i)},H.prototype.makeScreenShareConnecting=function(e,t){var i=t.chid,n=t.muteCbk,a=t.rejectCbk,o=t.media_id;t.name;this.initiateHeadshot(i);var r=this.states[i],s=0==this.container.screenShareImpl.getScreenShareType(i,o)?"sharing":"viewing";$.extend(!0,r,{handler:this.handleActionHandler.bind(this),name:T,url:D,chid:i,screen_share:{media_id:o,mute_cbk:n,reject_cbk:a,status:"connecting",type:s}}),this.__updateState(i)},H.prototype.makeScreenShareConnected=function(e,t){var i=this,n=t.media_id,a=t.chid,o=t.callEndCbk;this.initiateHeadshot(a);var r=this.states[a],s=0==this.container.screenShareImpl.getScreenShareType(a,n)?"sharing":"viewing";$.extend(!0,r,{handler:this.handleActionHandler.bind(this),name:T,url:D,screen_share:{reject_cbk:o,status:"connected",connected_time:(new Date).getTime(),type:s,swap_cbk:function(){return i.__swapScreen(n,a)}}}),setTimeout(this.startTimer.bind(this,a,e),500),this.__updateState(a)},H.prototype.makeScreenShareReconnecting=function(e,t){this.__makeReconnecting(e,t)},H.prototype.makeScreenShareEnded=function(e,t){this.__ssTerminate(e,t,"ended")},H.prototype.makeScreenShareCancelled=function(e,t){this.__ssTerminate(e,t,"cancelled")},H.prototype.makeScreenShareRejected=function(e,t){this.__ssTerminate(e,t,"rejected")},H.prototype.makeScreenShareMissed=function(e,t){this.__ssTerminate(e,t,"missed")},H.prototype.__ssTerminate=function(e,t,i){var n=this,a=t.chid,o=(t.media_id,this.states[a]);this.ss_invitation[a]&&(this.ss_invitation[a].rejectHandler(!1),delete this.ss_invitation[a]),o&&o.screen_share?(this.stopTimer(a,e),$.extend(!0,o,{screen_share:{status:i}}),setTimeout(function(){delete o.screen_share,n.__updateState(a),n.__checkAndDestroyInstance(a),o.player&&delete o.player},500),this.__updateState(a)):o&&this.__checkAndDestroyInstance(a)},H.prototype.showDialog=function(){},H.prototype.enableOutingCallUI=function(){},H.prototype.handleActionHandler=function(e,t,i){var n=this.states[e]&&this.states[e][t]&&this.states[e][t][i+"_cbk"];n&&n.call(this)},H.prototype.getTimeDiff=function(e){var t=(new Date).getTime()-e,i=(i=Math.floor(t%36e5/6e4))<10?"0"+i:i,n=(n=Math.floor(t%6e4/1e3))<10?"0"+n:n;return isFinite(i)&&isFinite(n)?i+":"+n:""},H.prototype.startTimer=function(t,i){var n=this;this.states[t][i].timer_ref||(this.states[t][i].timer_ref=setInterval(function(){var e=n.states[t];$.extend(!0,e[i],{timer:n.getTimeDiff(e[i].connected_time)}),n.__updateState(e.chid)},1e3))},H.prototype.stopTimer=function(e,t){var i=this.states[e];clearInterval(i[t].timer_ref),delete i[t].timer,this.__updateState(i.chid)},H.prototype.playSoundNotification=function(e,t){void 0===e&&(e="incomingcall"),void 0===t&&(t="audiocall");var i={type:t,duration:this.container.constants.WAITING_TIME_SECS,tone:e};this.container.detailsHandler.playNotifSound(i)},H.prototype.stopSoundNotification=function(){this.container.detailsHandler.stopNotifSound()},H.prototype.__updateState=function(e){var t=this.states[e];t&&([t.headshot,t.player,t.directCallUI].forEach(function(e){e&&e.updateState()}),this.handleMinimizeState())},H.prototype.__swapScreen=function(e,t){var i=this,n=this.container.detailsHandler.getEncryChid(t),a=A(t),o=h(y("div",{class:"zsiq_video_alert"},y("div",{class:"zsiq_valert_cnt"},LSResource.getRealValue("screenshare.swap.sharing")),y("div",{class:"zsiq_btnmain"},y("span",{class:"zsiq_valert_btn",onClick:function(){i.container.screenShareImpl.swapScreenShare({chatid:t,id:e},{chatid:n,wmsid:$Support.EmbedObj.vwmsid,lsuid:a.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid}),$(o).remove()}},LSResource.getRealValue("common.continue")),y("span",{class:"zsiq_valert_btn zsiq_redbtn",onClick:function(){return $(o).remove()}},LSResource.getRealValue("common.cancel")))));$(M()).append(o)},H.prototype.__makeReconnecting=function(e,t){var i=t.chid,n=(t.media_id,this.states[i]);this.stopTimer(i,e),n[e].status="reconnecting",this.__updateState(i)},H.prototype.shareScreen=function(e){var t=A(e);this.container.screenShareImpl.startScreenShare({chatid:t.chatID,wmsid:$Support.EmbedObj.vwmsid,lsuid:t.attender,lsid:$Support.getParent().$ZSIQWidget.getWidgetObject().lsid})},H.prototype.mediaPermissionUI=function(){var e,t,i=(e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t=h(y("div",{class:"zsiq_prv_main zsiq-cal-turtrp",onClick:function(){return $(t).remove()}},y("div",{class:"zsiq-cal-hnt-cont "+("Chrome"==e?"":"zsiq-"+e)},y("div",{class:"zsiq-trtp-anim"}),y("span",{class:"siqico-arrow zsiq-arrow"}),y("span",{class:"zsiq-alw-mic siqico-mic"}),y("div",{class:"zsiq-alw-mic-desc",html:LSResource.getRealValue("av.info.pleaseallowmicrophone")})))));return $(M()).append(i),function(){return $(i).remove()}},H.prototype.mediaPermissionUnlock=function(){var e,t,i=(e=getBrowserFromUserAgent(navigator.userAgent).split("-")[0],t=h(y("div",{class:"zsiq_prv_main zsiq-cal-turtrp",onClick:function(){return $(t).remove()}},y("div",{class:"zsiq-cal-hnt-cont zsiq-isblk "+("Chrome"==e?"":"zsiq-"+e)},y("div",{class:"zsiq-trtp-anim "}),y("span",{class:"siqico-arrow zsiq-arrow"}),y("div",{html:LSResource.getRealValue("av.info.pleasetaponlock","<em class='siqico-lock'></em>")}),y("p",null,"(",LSResource.getRealValue("common.or"),")"),y("div",null,LSResource.getRealValue("av.info.enablemicrophonesetting")),y("div",{class:"calndr-sedulbtn",style:"",onclick:g}," ",LSResource.getRealValue("chatwindow.mailcopy.clickhere")," ")))));return $(M()).append(i),$UI.showBanner(LSResource.getRealValue("av.info.microphone.blocked"),!0,null,15e3),function(){return $(i).remove()}},H.prototype.handleCallClash=function(e){e()},H.prototype.handleMinimizeState=function(){var e=this.invitations,t=this.container.commonImpl.getActiveCallData();e||t?($Support.getParent().$ZSIQWidgetUI.updateCallUI(),e?$Support.getParent().$ZSIQWidgetUI.updateIncomingCallUI():$Support.getParent().$ZSIQWidgetUI.removeIncomingCallUI()):$Support.getParent().$ZSIQWidgetUI.removeCallUI()},H.prototype.forceEndCall=function(){for(var e in this.states)this.container.commonImpl.endCallByChid(e),this.container.detailsHandler.triggerIconCheck(e)},H.prototype.implementRatingUI=function(e){var t,i,n=(i=e,h(y("div",{class:"cal-wrap",id:"audiocal"},y("div",{class:"posrel dib-mid"},y("div",{class:"cal-widgt theme1 outcal"},y("div",{class:"posrel usr-imginfo"},y("div",{class:"cal-visimg "},y("img",{src:(t=D)&&t(0,i)}))),y("div",{class:"cal-vstrdetl textC"},y("nav",{class:"cal-actvevstr elips font16"},LSResource.getRealValue("av.info.rating")),y("div",{class:"rating font18"},y("span",{class:"reaction_ico sad_icon","data-reaction":"sad",documentclick:"sendCallRating",title:LSResource.getRealValue("common.sad")}),y("span",{class:"reaction_ico neutral_icon","data-reaction":"neutral",documentclick:"sendCallRating",title:LSResource.getRealValue("common.neutral")}),y("span",{class:"reaction_ico happy_icon","data-reaction":"happy",documentclick:"sendCallRating",title:LSResource.getRealValue("common.happy")})),y("p",{class:"c777 font14"},LSResource.getRealValue("ne.rating.byline"))))))));CallImpl.isCallWithChat=this.container.detailsHandler.getEncryChid(e),SiqAVRouter.chatwinobj=this.container.detailsHandler.getChatWinObjById(e),this.container.detailsHandler.getChatWinObjById(e).hideMaskDiv(),JSON.parse($Support.EmbedObj.eprops.reaction[0])?($("#audiorec,#audiocal").remove(),$("body").prepend(n)):this.implementRatingFdbkUI(SiqAVRouter.chatwinobj)},H.prototype.implementRatingFdbkUI=function(e){var t,i,n,a,o,r=(t=e,i=D,n=T,a=ZSIQConversationManager.getChatWinObjById(t.chatID).RCHID,o=$Support.isSignature($Support.EmbedObj),h(y("div",{class:"cal-wrap",id:"audiocal"},y("div",{class:"adocal-cont dtfix "+k()+" cal-oflne",style:"height:354px;"},b(null,t),y("div",{class:"header"},o?"":y("div",{class:"actbtn"},y("em",{class:"sqico-min siq-minimize-icon",title:LSResource.getRealValue("ne.title.minimize"),documentclick:"min_iframe"})),y("div",{class:"posrel dib-mid"},y("div",{class:"cal-visimg sqico-user"},y("img",{src:i&&i(0,a)})),t.rating?y("em",{class:"reaction_ico "+t.rating+"_icon usr-rtng"}):""),y("div",null,y("div",{class:"cal-cmpname font20 fontB"},n(a)))),y("div",{class:"cal-bodycont posrel"},t.rating?y("div",{class:"ofln-msg mT5"}," ",$Support.getReactionIndex(t.rating)," "):""),y("div",{class:"cal-footer",style:"height:70px;"},y("textarea",{class:"bg-f6 font13 c333 lH20",dockeyup:"feedback",dockeydown:"textarea",id:"fdbkarea","data-validate":"required",placeholder:LSResource.getRealValue("av.info.fdkbckmsg"),autofocus:"",style:"overflow: hidden;"}),y("div",{class:"sqico-calsend fdbak-send msg-send",documentclick:"sendCallFb",title:LSResource.getRealValue("embed.submit")}))))));JSON.parse($Support.EmbedObj.eprops.feedback[0])?($($Support.getParent().document.body).find(".siqembed").removeClass("zsiq_size2"),$Support.getParent().$ZSIQWidgetUI.handlefbCall(),$("#audiorec,#audiocal").remove(),$("body").prepend(r)):this.directCallCancelled()},H.prototype.implementFdbkSuccessUI=function(e){var t,i,n,a,o,r=(t=e,i=D,n=T,a=ZSIQConversationManager.getChatWinObjById(t.chatID).RCHID,o=$Support.isSignature($Support.EmbedObj),h(y("div",{class:"cal-wrap",id:"audiocal"},y("div",{class:"adocal-cont dtfix "+k()+" cal-oflne"},b(null,t),y("div",{class:"header"},o?"":y("div",{class:"actbtn"},y("em",{class:"sqico-min siq-minimize-icon",title:LSResource.getRealValue("ne.title.minimize"),documentclick:"min_iframe"})),y("div",{class:"posrel dib-mid"},y("div",{class:"cal-visimg sqico-user"},y("img",{src:i&&i(0,a)})),t.rating?y("em",{class:"reaction_ico "+t.rating+"_icon usr-rtng",title:t.rating}):""),y("div",null,y("div",{class:"cal-cmpname font20 fontB"},n(a)))),y("div",{class:"cal-bodycont posrel"},y("div",{class:"ofln-msg mT5"},LSResource.getRealValue(t.rating?"av.info.ratingandfbk":"faq.feedback")),y("div",{class:"sqico-call bg-grn mT25 mA",title:LSResource.getRealValue("av.info.callagain"),onclick:function(){return parent.$zohosq.call.start()}}))))));$Support.getParent().$ZSIQWidgetUI.handleMinCall(),$("#audiorec,#audiocal").remove(),$("body").prepend(r)},H.prototype.directCallCancelled=function(){$("#audiorec,#audiocal").remove(),$("body").prepend(CallUIHandler.getCallCancelledHtml()),$Support.isSignature($Support.EmbedObj)&&$("div.actbtn").remove(),$($Support.getParent().document.body).find(".siqembed").removeClass("zsiq_size2"),$Support.getParent().$ZSIQWidgetUI.handleMinCall()};function O(e){this.container=e}O.prototype.post=function(e,t,i,n){this.request("POST",e,t,i,n)},O.prototype.get=function(e,t,i){this.request("GET",url,e,t,i)},O.prototype.request=function(e,t,i,n,a){var o=_SCHEMA+"://"+_EMBEDSERVERURL+"/visitor/v2/"+_SCREENNAME+"/"+t;try{$.ajax({url:o,type:e,data:i,success:n||function(){},error:a||function(){}})}catch(e){}};function E(e){this.container=e,this.uiutil=$Support,this.isembed=!0}E.prototype.handleEndSession=function(e,t){this.onGoingCallForChat(e)?this.container.commonImpl.endCallByChid(e,t):t()},E.prototype.onGoingCallForChat=function(e){return!!this.container.commonImpl.getCallStatusByChid(e)},E.prototype.getEncryChid=function(e){return $Support.chidmappinglist[e]},E.prototype.isEmbed=function(){return this.isembed},E.prototype.getChatWinObjById=function(e,t){void 0===t&&(t=!1);var i=t?e:this.getEncryChid(e);return ZSIQConversationManager.getChatWinObjById(i)},E.prototype.getSupportReps=function(e,t){void 0===t&&(t=!1);var i=t?e:this.getEncryChid(e);return SUPPORT_REPS[i]||null},E.prototype.getSupportRepCount=function(e,t){void 0===t&&(t=!1);var i=this.getSupportReps(e,t);return i&&Object.keys(i).length},E.prototype.isGroupConversation=function(e,t){void 0===t&&(t=!1);try{return 1<this.getSupportRepCount(e,t)}catch(e){return!1}},E.prototype.isAttenderBot=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).isBotChat},E.prototype.isChatExist=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).isAudioCallAllowed()},E.prototype.getAttenderId=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).attender},E.prototype.isProactiveChat=function(e,t){return void 0===t&&(t=!1),this.getChatWinObjById(e,t).proactive},E.prototype.getCurrentUserId=function(){return null},E.prototype.playNotifSound=function(e){var t=e.tone,i=e.duration,n=e.chatid,a=e.isEncrypted,o=!n||this.getChatWinObjById(n,a);n&&o.isSoundOff()||EmbedSound.play(t,i)},E.prototype.stopNotifSound=function(){EmbedSound.stop()},E.prototype.initMissedChat=function(e,t,i,n){var a=e?this.getChatWinObjById(e):ZSIQConversationManager.getcurrchatwinobj();delete $Support.requestRunning_missedvisitor,this.uiutil.handleMissed(t,i,n,a),this.uiutil.removeWtimeCookie(a.chatID),delete a.reopenwaiting,$Support.removeBroadCast()},E.prototype.clearPlayer=function(){this.getBody().find(".zsiq_video_main").remove()},E.prototype.getBody=function(){return $(parent.document.body)},E.prototype.triggerAudioCallIcon=function(e,t){var i=$("#audiocall");"show"==t?(this.showAudioCall(),i.removeClass("cmn_disable").show(),i.show().parent().addClass("rgt_ico")):"hide"==t?(this.hideAudioCall(),i.hide().parent().removeClass("rgt_ico")):"disable"==t&&(this.showAudioCall(),i.addClass("cmn_disable"))},E.prototype.triggerScreenShareIcon=function(){},E.prototype.showAudioCall=function(){$("#audiocall").show(),$(".callagain-txt").show()},E.prototype.hideAudioCall=function(){$("#audiocall").hide(),$(".callagain-txt").hide(),$("#call_Busy").remove()},E.prototype.isAudioCallEnabled=function(){var e="true"==$Support.getParent().$ZSIQChat.getWidgetData().embedobj.isaudiocallallowed,t="true"==$Support.EmbedObj.eprops.isaudiocall;return e&&t},E.prototype.isPlanAllowed=function(){return Licence.verify("audiocall")},E.prototype.isScreenShareAllowed=function(){return CommonUtil.isScreenshareEnabledFromPortal()&&$Support.EmbedObj.eprops.issiqscreenshare&&Licence.verify("issiqscreenshare")},E.prototype.hasIncomingCall=function(e){var t,i=this.container.commonImpl.getCallStatusByChid(e);for(t in i){var n=i[t];if("audio"==n.type&&"incoming"==n.callType&&"ringing"==n.callStatus)return!0}return!1},E.prototype.isActiveBySSType=function(e){var t={isActive:!1,id:null},i=this.container.commonImpl.getActiveCallData();if(!i)return t;if(i==e){var n,a=this.container.commonImpl.getCallStatusByChid(i);for(n in a){var o=a[n].type,r=a[n].id;if("screen_share"==o)return t.isActive=!0,t.id=r,t}}return t},E.prototype.isShareScreenAllowed=function(e){if(!this.container.commonImpl.currentUserBrowserSupportSS())return!1;var t=this.isActiveBySSType(e),i=t.isActive,n=t.id;return 0!=this.container.screen_shareImpl.getScreenShareType(e,n)||!i},E.prototype.checkIsSSOnGoing=function(e,t){var i=this.container.commonImpl.getActiveCallData();return!!i&&(i!=e||("share_screen"==t?this.isShareScreenAllowed(e):"view_screen"==t?this.isRequestScreenShareAllowed(e):void 0))},E.prototype.checkActiveScreenShare=function(e,t){var i,n=this.container.commonImpl.getCallStatusByChid(e);for(i in n){var a=n[i],o=a.id;if("screen_share"==a.type){var r=this.container.screenShareImpl.getScreenShareType(e,o);if(1==r)return this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:o,chatid:e}),this.container.screenShareImpl.startScreenShare(t),!0;if(0==r)return this.container.screenShareImpl.handleUIEnd({type:"screen_share",id:o,chatid:e}),this.container.screenShareImpl.startScreenShare(t),!0}}return!1},E.prototype.isSecureConnection=function(){return-1<window.location.protocol.indexOf("https")},E.prototype.isAudioRecordingSupported=function(){return window.AudioContext=window.AudioContext||window.webkitAudioContext,window.URL=window.URL||window.webkitURL,navigator.getUserMedia=this.container.MediaPermission.getUserMediaDetail(),window.AudioContext&&navigator.getUserMedia&&window.URL&&window.Worker||(support=!1),!0},E.prototype.closeViewMediaPermission=function(){$(window.parent.document).find("body").find(".zsiq_prv_main").remove()},E.prototype.isliveChatWindow=function(){return"msgarea"==$Support.container.attr("cwview")},E.prototype.isFaceBookIntegration=function(){return-1<window.location.href.lastIndexOf("facebook.ext")},E.prototype.getVisitorWMSID=function(){return this.uiutil.EmbedObj.vwmsid},E.prototype.getLsid=function(){return $Support.getParent().$ZSIQWidget.getWidgetObject().lsid},E.prototype.getVisitorID=function(){},E.prototype.getVisitorBrowser=function(){},E.prototype.getVisitorUserAgent=function(){},E.prototype.getVisitorPage=function(){},E.prototype.getUTSDetail=function(){},E.prototype.isMobileVisitor=function(){},E.prototype.isIOSSDKVisitor=function(){},E.prototype.isChatMonitor=function(){return!1},E.prototype.getCurretUserLSUID=function(){},E.prototype.I18N=function(){},E.prototype.getChatAttender=function(){},E.prototype.isVisitorOnline=function(){},E.prototype.isOngoingChat=function(){return!1},E.prototype.checkBrowserSupported=function(){},E.prototype.getBrowserFromUserAgent=function(){},E.prototype.addVisitorDetail=function(){},E.prototype.pickupsupport=function(){},E.prototype.endSession=function(e){var t=e?this.getChatWinObjById(e):ZSIQConversationManager.getcurrchatwinobj();$Support.quitChat(t)},E.prototype.getChatIdByVisitorId=function(){},E.prototype.isScreenShareEnabled=function(){},E.prototype.sendDebugLogger=function(){},E.prototype.hideAudioCallIcon=function(){},E.prototype.showAudioCallIcon=function(){},E.prototype.disableCallAgainOption=function(){},E.prototype.showCallAgainOption=function(){},E.prototype.removeAudioCallIcon=function(){},E.prototype.isCallIconEnabled=function(){},E.prototype.initVideoPlayer=function(){},E.prototype.isAllowedForCurrTab=function(){},E.prototype.getRepresentative=function(){},E.prototype.isVisitorBrowserSupported=function(){},E.prototype.isVisitorOSSupported=function(){},E.prototype.getVisitorOS=function(){},E.prototype.audioIconStatus=function(){},E.prototype.screenshareIconStatus=function(){},E.prototype.triggerIconCheck=function(e){this.container.audioImpl.audioIconStatus(e,this.triggerAudioCallIcon.bind(this))},E.prototype.focusChatWindow=function(){},E.prototype.joinChat=function(){},E.prototype.canShowAudioCallInvitation=function(){return!0},E.prototype.endCall=function(e,t){this.container.commonImpl.endCallByChid(e,t)},E.prototype.isAudioCallDisabled=function(){return!1},E.prototype.toJSON=function(e){return JSON.stringify(e)},E.prototype.handleCallInitiate=function(){},E.prototype.handleCallEnded=function(){},E.prototype.handleCallCancelled=function(){},E.prototype.handleCallRejected=function(){},E.prototype.handleCallMissed=function(){};function j(e){this.container=e,this.init(e)}j.prototype.handle=function(e){this.route(e.param)},j.prototype.route=function(e){var t,i,n=e.msg.media,a=n.type,o=n.chatid,r=n.id,s=e.msg,c=s.operation;s.cbtype;this.checkIsCurrentTab(o)||-1!=["call_initiate","call_cancel","call_miss"].indexOf(c)?d(i=(t=this.getController(a))&&t[this.getHandler(e)])&&(i.call(t,e.msg.media),this.container.commonImpl.sendMediaStats(e,null)):(this.container.uiHandler.clearAudioCallInvite(a,r),this.container[a+"Impl"].clearData(e.msg.media),Sound.stop())},j.prototype.init=function(e){this.audio_impl=e.audioImpl,this.video_impl=e.videoImpl,this.screen_share_impl=e.screenShareImpl,this.common_impl=e.commonImpl},j.prototype.getController=function(e){return this[e+"_impl"]},j.prototype.getHandler=function(e){var t=e.msg,i=t.cbtype,n=t.status,a=t.operation,o=this.getStatus(n),r=this.getOperations(a),s=this.getCBTypes(i);return o||r||s},j.prototype.getOperations=function(e){return{call_credential:"setCredential",call_initiate:"handleInvitation",call_accept:"handleCallAccept",call_reject:"handleCallReject",call_candidates:"handleCandidates",call_answer:"handleCallAnswer",call_end:"handleCallEnd",call_offer:"handleCallOffer",call_cancel:"handleCallCancel",call_miss:"handleCallMissed",call_invite:"handleCallInvite"}[e]},j.prototype.getCBTypes=function(){return{credential:"setCredential",invite:"handleInvitation",reject:"handleCallReject",candidate:"handleCandidates",answer:"handleCallAnswer",offer:"handleCallOffer",cancel:"handleCallCancel",miss:"handleCallMissed",invite:"handleCallInvite"}},j.prototype.getStatus=function(e){return{accept:"handleCallAccept",end:"handleCallEnd"}[e]},j.prototype.checkIsCurrentTab=function(){return Boolean(this.container.commonImpl.getActiveTab())};function U(){this.container=this.container}U.prototype.getEventsMap=function(){return{mute:"",end_media:"",sharescreen:"",shareaudio:"",stop_audio:"",stop_screenshare:""}};function L(e){this.container=e,this.init(e)}L.prototype.handle=function(){},L.prototype.init=function(){};function B(e){this.conatiner=e}B.prototype.handle=function(){};function P(e){((this.container=e).MediaPermission=this).isSupported=void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia,this.displayMediaSupported=this.isSupported&&navigator.mediaDevices.getDisplayMedia&&void 0!==navigator.mediaDevices.getDisplayMedia,this.init(),this.getmediaDevices(this.updateMediaDevices.bind(this),null)}P.prototype.init=function(){this.type={audio:"audio",video:"video",audio_video:"audio_video",screen:"screen_share"},this.streamType={audio:1,video:2,screen:3,audio_video:4},this.streamTypeInString={1:"audio",2:"video",3:"screen_share",4:"audio_video"},this.devicesType={audioInput:"audioinput",videoInput:"videoinput",audioOutput:"audiooutput"}},P.prototype.isDisplayMediaSupported=function(){return this.displayMediaSupported},P.prototype.updateMediaDevices=function(e){this.devicesArray=e;var t,i=[],n=[];for(t in this.devicesArray){var a=this.devicesArray[t];a.kind==this.devicesType.audioInput?i.push(a):a.kind==this.devicesType.videoInput&&n.push(a)}this.availableDevices={audioInput:i,videoInput:n}},P.prototype.getAvailableDevices=function(){return this.availableDevices},P.prototype.getmediaDevices=function(t){void 0!==navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices().then(function(e){return t(e)})},P.prototype.updatePreferredDevice=function(e){this.preferredDevice||(this.preferredDevice={}),this.preferredDevice[e.type]=e},P.prototype.getPreferredDevice=function(e){return this.preferredDevice?this.preferredDevice[e]:null},P.prototype.getAudioInputDevices=function(){return this.availableDevices.audioInput},P.prototype.getVideoInputDevices=function(){return this.availableDevices.videoInput},P.prototype.getMediaConstraints=function(e,t){var i={},n=!0,a=!0,o=this.getPreferredDevice(this.devicesType.audioInput),r=this.getPreferredDevice(this.devicesType.videoInput);return o&&(n={deviceId:{exact:o.deviceId}}),r&&(a={deviceId:{exact:r.deviceId}}),i=Object.assign({},{audio:n,video:a},t),e==this.type.audio?i.video=!1:e!=this.type.video&&e!=this.type.screen||(i.audio=!1),i},P.prototype.requestStream=function(i,n,t,e,a,o){var r,s,c=this,d=null;this.streams?d=this.streams[i]:this.streams=[],d?n():(r=a?navigator.mediaDevices.getDisplayMedia:navigator.mediaDevices.getUserMedia,s=this.getMediaConstraints(i,e),r.call(navigator.mediaDevices,s).then(function(e){var t;c.setType(e,i),c.streams[i]=e,"function"!=typeof o||(t=e._getPrimaryVideoTrack())&&(t.onended=o),n()}).catch(function(e){t(e,i)}))},P.prototype.getAudioStream=function(e,t,i,n){this.requestStream(this.type.audio,e,t,i,!1,n)},P.prototype.getVideoStream=function(e,t,i,n){this.requestStream(this.type.video,e,t,i,!1,n)},P.prototype.getScreenShareStream=function(e,t,i,n){var a;this.displayMediaSupported?this.requestStream(this.type.screen,e,t,i,!0,n):(a={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId}}},this.requestStream(this.type.screen,e,t,a,!1,n))},P.prototype.getStreamByType=function(e){return this.streams?this.streams[e]:null},P.prototype.getScreenSharePermissionWithAudio=function(){},P.prototype.getAudioPermission=function(e,t){this.getPermission(this.type.audio,e,t)},P.prototype.getVideoPermission=function(e,t){this.getPermission(this.type.video,e,t)},P.prototype.getPermission=function(e,t,i){navigator.permissions.query({name:e}).then(function(e){"function"==typeof t&&t(e.state)}).catch(function(e){"function"==typeof i&&i(e)})},P.prototype.setType=function(e,t){var i="";return e.salesiq||(i=e.salesiq={}),i._type=t,i},P.prototype.getTypeFromStream=function(e){return e&&e.salesiq&&e.salesiq._type?e.salesiq._type:null},P.prototype.closeAllStream=function(){for(var e in this.streams)this.closeStream(e)},P.prototype.closeStreamByType=function(e){this.closeStream(e)},P.prototype.closeStream=function(e){var t=this.streams?this.streams[e]:null;if(t){var i,n=t.getTracks();for(i in n)n[i].stop();this.streams[e]=null}},P.prototype.toggleMute=function(){var e=this.streams[this.type.audio];e.getAudioTracks()[0].enabled=!e.getAudioTracks()[0].enabled},P.prototype.screenEndFromBrowserUI=function(e){this.streams[this.type.screen].getVideoTracks()[0].onended=function(){e()}},P.prototype.getUserMediaDetail=function(){return navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null},P.prototype.getTracksId=function(){var e,t={};for(e in this.streams)t[e]=this.streams[e]&&this.streams[e].id;return t};function V(e){this.container=e,this.userAgent=navigator.userAgent,this.browserName=null,this.browserVersion=null,this.browserSupported=!1,(e.MediaDetails=this).platform=navigator.platform,this.setBrowserName()}V.prototype.setBrowserName=function(){var e,t,i,n,a,o=(e=this.userAgent,i="unknown-unknown",-1<(a=(n=e).toLowerCase()).indexOf("msie")?i=(t=n.substring(n.indexOf("MSIE")).split(";")[0]).split(" ")[0].replace("MSIE","IE")+"-"+t.split(" ")[1]:-1<a.indexOf("edge")?i=n.substring(n.indexOf("Edge")).split(" ")[0].replace("/","-"):-1<a.indexOf("safari")&&-1<a.indexOf("version")?i=n.substring(n.indexOf("Safari")).split(" ")[0].split("/")[0]+"-"+n.substring(n.indexOf("Version")).split(" ")[0].split("/")[1]:-1<a.indexOf("opr")||-1<a.indexOf("opera")?-1<a.indexOf("opera")?i=n.substring(n.indexOf("Opera")).split(" ")[0].split("/")[0]+"-"+n.substring(n.indexOf("Version")).split(" ")[0].split("/")[1]:-1<a.indexOf("opr")&&(i=n.substring(n.indexOf("OPR")).split(" ")[0].replace("/","-").replace("OPR","Opera")):-1<a.indexOf("chrome")?i=n.substring(n.indexOf("Chrome")).split(" ")[0].replace("/","-"):-1<a.indexOf("firefox")&&(i=n.substring(n.indexOf("Firefox")).split(" ")[0].replace("/","-")),[i,parseInt(i.split("-")[1])]);this.browserName=o[0],this.browserVersion=o[1]},V.prototype.getBrowserName=function(){return this.browserName},V.prototype.getBrowserVersion=function(){return this.browserVersion},V.prototype.checkBrowserSupported=function(){var e=this.browserName.split("-")[0];return this.browserSupported=!1,"Chrome"==e?this.browserSupported=23<=this.browserVersion:"Firefox"==e?this.browserSupported=22<=this.browserVersion:"Opera"==e?this.browserSupported=18<=this.browserVersion:"Safari"==e&&(this.browserSupported=11<=this.browserVersion),this.browserSupported},V.prototype.getPlatform=function(){return this.platform};function x(e){this.data={},this.container=e,this.unique="SiqMedia_",e.dataHandler=this}x.prototype.get=function(e){this.getLocalKey(e);return this.data[e]},x.prototype.set=function(e,t){this.getLocalKey(e);this.data[e]=t},x.prototype.remove=function(e){this.getLocalKey(e);this.data[e]&&delete this.data[e]},x.prototype.getLocalKey=function(e){return this.unique+e};function N(e){(e.router=this).container=e,this.init(e)}var z={WAITING_TIME:6e4,WAITING_TIME_SECS:60,audio:"audio",video:"video",screen_share:"screen_share",0:"audio",2:"video",1:"screen_share",connecting:"connecting",facebookUrl:"https://facebook.com/pages",negotiation:"negotiation"};N.prototype.init=function(e){this.rtc_router=new j(e),this.event_router=new U,this.media_router=new L(e),this.action_router=new B(e),this.MediaPermission=new P(e),this.dataHandler=new x(e),this.MediaDetails=new V(e),this.container.constants=z},N.prototype.route=function(e){if(!this.validateRouteObject(e))throw"Media Router Schema Mismatch";this.handle(e)},N.prototype.handle=function(e){try{var t=this[e.type+"_router"];t&&t.handle&&t.handle(e)}catch(e){}},N.prototype.validateRouteObject=function(t){var i={type:"string",module:"string",useCase:"string",param:"object"},n=!0;return Object.keys(i).forEach(function(e){t[e]&&typeof t[e]==i[e]||(n=!1)}),n};function F(e){(e.LSRouter=this).container=e,this.init()}F.prototype.init=function(){var e=this,t=this;this.container;this.routes={0:function(){return e.container.checkDirectCallOnload()},2:t.handleCustomMessage(),29:t.handleAVcall.bind(t),13:t.handleUserStatus.bind(t),113:t.chatEnded.bind(t),35:t.chatEnded.bind(this),114:t.checkForCallIcon.bind(this),14:t.checkForCallIcon.bind(this),15:t.checkForCallIcon.bind(this)}},F.prototype.chatEnded=function(e){var t=e.msg.chid;$("#call_Busy").remove(),this.container.uiHandler.clearAudioCallInvite(t),this.container.detailsHandler.triggerIconCheck(t),this.container.detailsHandler.hideAudioCall()},F.prototype.handleMessage=function(e){var t,i,n=this.routes,a=typeof n[e.mtype];try{"function"==a?n[e.mtype].call(this,e):"object"==a&&(t=this.getModuleName(e),"function"==typeof(i=n[e.mtype][t])&&i.call(this,e))}catch(e){}},F.prototype.handleCustomMessage=function(){var e=this;return{addvisitor:e.showInvitation,acctranschat:e.endCall,closetransfer:e.checkForCallIcon,pickupsupport:e.handlePicksupport,leavesupport:e.endSupport,missedvisitor:e.missedDirectCall,joinsupport:e.joinsupport}},F.prototype.handlePicksupport=function(e){var t=e.msg,i=LSMessanger.getPrd()+"_"+$Support.getParent().$ZSIQWidget.getEmbedObject().pinfo.soid+"_"+t.attender;try{for(var n in SUPPORT_REPS[t.chid])n!=i&&delete SUPPORT_REPS[t.chid][n]}catch(e){}this.checkForCallIcon(e)},F.prototype.handlePresenceMessage=function(){return{}},F.prototype.handleLsOperations=function(e){var t={}[e.msg.msg.mode||JSON.parse(e.msg.msg).mode];"function"==typeof t&&t(e.msg)},F.prototype.handleAVcall=function(e){e.msg.msg=JSON.parse(e.msg.msg),e.msg.msg.media=JSON.parse(e.msg.msg.media),this.container.router.route({type:"rtc",module:e.msg.msg.media.type,useCase:e.msg.msg.cbtype||e.msg.msg.operation,param:e.msg})},F.prototype.getModuleName=function(t){return{2:"msg > module",114:"msg > msg > mode",700:"msg > msg > module"}[t.mtype].trim().split(/\s*\>\s*/g).forEach(function(e){return t=t[e]}),t},F.prototype.showInvitation=function(e){try{var t=e.msg,i=t.media;if(!i)return;var n,a="";for(n in i)a=JSON.parse(i[n]).type;this.container[a+"Impl"].handleApiCallInvitation(t)}catch(e){}},F.prototype.missedDirectCall=function(e){var t=e.msg,i=t.media;if(i){for(var n in i){var a=JSON.parse(i[n]),o=a.type,r={chatid:this.container.detailsHandler.getChatIdByVisitorId(t.visitorid),id:a.id,type:o};this.container[o+"Impl"].handleCallCancel(r)}}},F.prototype.checkForCallIcon=function(e){var t=this.container,i=e.msg,n=i.chatid||i.chid;t.detailsHandler.triggerIconCheck(n),t.detailsHandler.isGroupConversation(n)&&$("#call_Busy").remove()},F.prototype.endSupport=function(e){var t,i=e.msg,n=i.chatid||i.chid,a=this.container,o=a.detailsHandler,r=a.commonImpl,s=a.uiHandler,c=r.getCallStatusByChid(n);for(t in c){var d=c[t],l=d.type,u=this.container[l+"Impl"],p=d.id,h={chid:n,media_id:p,type:l};s.updateCallInvitationState(l,h,"ended"),s.clearAudioCallInvite(l,p),h.mid=p,u.clearData(h)}o.removeAudioCallIcon(n),o.removeScreenShareIcon(n),r.checkAndPlayNotification()},F.prototype.disableAvIcons=function(){},F.prototype.endCall=function(e){try{var t=this.container,i=e.msg,n=i.chatid||i.chid;t.commonImpl.endCallByChid(n),this.checkForCallIcon(e)}catch(e){}},F.prototype.handleUserStatus=function(e){this.checkForCallIcon(e)},F.prototype.joinsupport=function(e){this.checkForCallIcon(e),this.container.commonImpl.checkOnGoingCall()},$(document).ready(function(){var e,o={},t=$Support.getParent();(e=o).commonImpl=new c(e),e.audioImpl=new a(e),e.videoImpl=new s(e),e.screen_shareImpl=new r(e),o.uiHandler=new H(o),o.ajaxHandler=new O(o),o.detailsHandler=new E(o),o.logger=LSDebugger.postDebugInfo,o.lsrouter=new F(o),window.SiqAVRouter=new N(o),window.avUIhandler=o.uiHandler,o.commonImpl.checkOnGoingCall(),o.checkDirectCallOnload=function(){var e,t,i,n,a=localStorage.getItem("siq_directcall");(a=a&&JSON.parse(a))&&(e=a.chid,t=a.media_id,i=a.type,"outgoing"==(n=a.status)?($Support.audioid=t,o.commonImpl.makeCallMissed(i,t),o.detailsHandler.initMissedChat(e,"CALLENDED","2",!0)):"connected"==n&&(o.audioImpl.endOngoingCall(e,t),o.detailsHandler.endSession(e)),localStorage.removeItem("siq_directcall"))},!$Support.isChatExist()&&t.$zohosq.values.initiatecall&&t.$zohosq.call.start()})}();
